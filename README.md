# Расчетно-пояснительная записка

<h3 id="Content">Содержание</h3>

#### 1. [Тема и целевая аудитория](#1)
#### 2. [Расчет нагрузки](#2)
#### 3. [Глобальная балансировка нагрузки](#3)
#### 4. [Локальная балансировка нагрузки](#4)
#### 5. [Логическая схема базы данных](#5)
#### 6. [Физическая схема базы данных](#6)
#### 7. [Алгоритмы](#7)
#### 8. [Технологии](#8)
#### 9. [Обеспечение надёжности](#9)
#### 10. [Схема проекта](#10)
#### 11. [Список серверов](#11)


<h2 id="1">1 Тема и целевая аудитория</h2>

В качестве типа сервиса для проектирования я выбрал маркетплейс **Яндекс Маркет**. Данный сервис отвечает требованиям к теме:

- **Имеет реальные аналоги**, доказывающие существование рыночной ниши — Ozon, Wildberries, Купер.
- **Аудитория сервиса** свыше 1 миллиона активных пользователей по данным [inclient.ru](https://inclient.ru/yandex-stats).
  
  | Яндекс Маркет           | Количество  |
  |-------------------------|-------------|
  | **Активные покупатели** | 18.2 млн    |
  | **Активные продавцы**   | 80.6 тысяч  |

- Наибольшим спросом **Яндекс Маркет** пользуется в России (94.48% интернет-трафика), Беларуси (0.97%), Узбекистане (0.74%) и Казахстане (0.73%).
- **Имеет сложную, нетривиальную архитектуру**.

## Функционал

Ключевой функционал для данного сервиса:

1. **Поиск и фильтрация товаров**
   - Система поиска использует **алгоритмы машинного обучения** для более точного подбора результатов на основе предпочтений пользователя. Это также включает умные фильтры, которые позволяют пользователям быстро находить подходящие товары.

2. **Система отзывов и рейтингов**
   - Интегрированная система отзывов с **верификацией подлинности** (например, отзывы только от пользователей, которые действительно купили товар) и **фильтры для сортировки отзывов** по полезности, дате или оценке.
  
3. **Рекомендации товаров в ленте**
   - **Рекомендации товаров в ленте** на основе пользовательских просмотров и ранее совершенных покупок. Это позволяет персонализиовать ленту товаров для пользователя и его удобства.

4. **Оформление заказа**
   - Возможность выбора из нескольких вариантов доставки (курьером, в пункт выдачи, постамат) и множества способов оплаты (банковские карты, электронные кошельки, наложенный платеж). Платформа также позволяет пользователям сохранять несколько адресов доставки.

5. **Сравнение товаров**
   - **Сравнение товаров** с выделением ключевых характеристик и различий, что помогает пользователям принять обоснованное решение.

6. **Управление учетной записью и заказами**
   - **Личный кабинет** с возможностью настройки профиля, просмотра истории покупок и отслеживания текущих заказов.

## Сокращение до MVP

Для создания MVP (минимально жизнеспособного продукта) Яндекс Маркета можно урезать функционал до следующих ключевых функций:

1. **Поиск и фильтрация товаров** (с базовыми фильтрами).
2. **Система отзывов и рейтингов** (с текстовыми отзывами и оценками).
3. **Рекомендации товаров в ленте**.
4. **Оформление заказа** (с одним способом доставки и оплаты).
5. **Сравнение товаров** (базовое сравнение двух товаров по ключевым характеристикам).
6. **Управление учетной записью и заказами** (с основными функциями).

<h2 id="2">2 Расчет нагрузки</h2>

### Продуктовык метрики
- **MAU** - 30,66 млн (https://dzen.ru/a/ZkT8wKCKkBgtJMT-)
- **DAU** - 8,76 млн

Данные о товаре на Яндекс Маркете необходимые для его публикации (https://yandex.ru/support2/marketplace/ru/assortment/fields/)
  | Данные           | Размер (предполагаемый)  |
  |---------|-------------|
  | **SKU** | 0.51 КБ    |
  | **Название**   | 0.51 КБ |
  | **Изображения**   | 30*10 МБ  |
  | **Базовая цена**   | 0.0039 КБ |
  | **Фото 360**   | 72*10 МБ  |
  | **Видео**   | 3*60 МБ  |
  | **Описание**   | 12 КБ  |
  | **Категория товара**   | 0.2 КБ  |
  | **...**   | ...  |
  
Размеры в мегабайтах:
0.00051 + 0.00051 + 300 + 720 + 180 + 0.012 + 0.0002 = 1200.02321 МБ.

Округлим до 1200 МБ, потому как так еще остались возможные характеристики товаров, но по сравнению с размерами медиа-файлов их размел мал.
Таким образом, предполагаемый общий объем данных составляет около 1200 МБ, или 1.2 ГБ.*

>*Яндекс не храниит большие размеры медиа-файлов, а сжимает до нескольких копий для разного размера экрана:
>
> **Изображения:**
> | Размер изображения | Память                |
> |--------------------|-----------------------|
> | 190×250            | 0.14 МБ               |
> | 240×320            | 0.23 МБ               |
> | 300×400            | 0.36 МБ               |
> | 351×468            | 0.49 МБ               |
> | 402×536            | 0.65 МБ               |
> | 450×600            | 0.81 МБ               |
> | 501×668            | 1.00 МБ               |
> | 552×736            | 1.22 МБ               |
> | 600×800            | 1.44 МБ               |
> | **Всего сумма**    | **6.34 МБ**           |
>
>  **Видео:**
> | Тип данных         | Разрешение  | Память                |
> |--------------------|-------------|-----------------------|
> | Прелоад изображения | 600×800     | 1.44 МБ               |
> | Первоначальный кадр видео | 1080×1920 | 6.22 МБ               |
> | Стриминг видео (прогрессивный) | Зависит от сегментации и сети | Переменная (зависит от продолжительности и качества) |
> | **Всего (без учёта стрима)**  |             | **7.66 МБ + стрим**  |
>
> Таким образом размеры стоит пересчитать, взяв что в среднем на товар приходится 10 фотографий и 1 видео, а не 30 и 3 соответсвенно: 
> 0.00051 + 0.00051 + 10*6.4 + 24*6,4 + 60 + 0.012 + 0.0002 = 278 МБ.
>
> Это кажется не слишком сильно сократило размер хранения, но это сильно уменьшило размеры подгружаемых файлов файлов, потому загружается только фотография нужного формата для ленты, а видео там нет вообще. Возьмем среднее значение для изображений для ленты 402х556 - **0,65 МБ**


Основные действия по функционалу MVP:

  | Действие | Кол-во в день на одного пользователя в среднем  |
  |---------|-------------|
  | **Поиск и фильтрация товаров** | 4 |
  | **Система отзывов и рейтингов**   | 0.03 (1 в месяц) |
  | **Оформление заказа**   | 0.14 ( 1 в неделю )   |
  | **Сравнение товаров**   | 1 |
  | **Управление учетной записью и заказами**   | 0.14 ( 1 в неделю )  |
  
### Технические метрики

- **Хранилище**:  
  Количество товаров на Яндекс Маркете — **108 млн** ([Источник](https://yastatic.net/s3/ir-docs/docs/2024/q2/57a1cu049ffbd144aeged36d47h173c2/MKPAO_Press_Release_RUS_rs94k.pdf)).

  Посчитав до этого, сколько примерно нужно для хранения одного товара, получаем **3.1 петабайта** памяти.

- **Сетевой трафик**  
  Расчитаем трафик для активностей, выбранных в MVP:

  - **Поиск товаров (лента)**:  
    4 запроса/день, при которых загружаются 20 товаров с одной фотографией среднего размера (который мы выбрали до этого — **0.65 МБ**), названием (**0.51 КБ**) и ценой (**0.0039 КБ**).  
    Рассчитаем:  
    `4 * 20 * (665 + 0.51 + 0.0039) КБ = 52 МБ`

  - **Оставление отзыва**:  
    0.03 запроса/день. Средний размер отзыва — 3 текстовых поля по 200 символов и 3 фотографии 600×800, что в сумме составляет **4.32 МБ**.  
    Рассчитаем:  
    `0.03 * 4.32 МБ = 0.144 МБ`

  - **Оформление заказа**:  
    0.14 запроса/день. В среднем заказ включает 3–4 товара, возьмем 4. Размер одного товара:  
    `0.00051 КБ + 0.00051 КБ + 6.4 МБ + 0.012 КБ + 0.0002 КБ = 6.5 МБ`,  
    так как при загрузке не отображаются видео и Фото 360, а показывается 1 фотография.  
    Рассчитаем:  
    `0.14 * 4 * 6.5 МБ = 3.64 МБ`

  - **Сравнение товаров**:  
    1 запрос/день. Возьмем те же условия, что и в прошлом пункте, но товары для сравнения загружаются в количестве 2–3.  
    Рассчитаем:  
    `1 * 3 * 6.5 МБ = 19.5 МБ`

  **Итого сетевой трафик на одного пользователя в день**:  
  `52 + 0.144 + 3.64 + 19.5 = 72.2 МБ`
- **Сетевой трафик по видам активности (дневная аудитория 8.76 млн. пользователей):**

  Пиковое значение активности пользователей(соответственно RPS тоже) приблизительно в 1.66 раза выше среднего значения. Возьмем коэффициент запаса равный 2
  
  Тип                           | Отправка (дневная аудитория 8.76 млн) | Отправка Гб/сек | Пиковое значение | Значение с коэффициентом запаса 2 |
  -------------                 | ------------------------------------  |---------------- |----------------- |---------------------------------- |
  Поиск товаров                 | 8.76 млн * 52 МБ = 434 ТБ             | 5.14            | 8.53             | 10.28                            |
  Оставление отзывов            | 8.76 млн * 0.144 МБ = 1.2 ТБ          | 0.014           | 0.023            | 0.028                              |
  Оформление заказа             | 8.76 млн * 3.64 МБ = 30 ТБ            | 0.35            | 0.581            | 0.7                              |
  Сравнение товаров             | 8.76 млн * 19.5 МБ = 162 ТБ           | 1.92            | 3.19             | 3.84                             |
  Итого                         | 627,2 ТБ	                            | 7.424           | 12.32            | 14.85                              |
- **RPS**
 
  * Поиск товаров: 8.76 млн * 4 / 86400 = 387 RPS
  * Добавление товаров в корзину: 8.76 млн * 0.03 / 86400 = 2.9 RPS
  * Оформление заказов: 8.76 млн. * 0.14 / 86400 = 13.5 RPS
  * Оставление отзывов: 8.76 млн. * 1 / 86400 = 96.8 RPS
  
| Действие                                  | RPS  | Пиковое значение | Пиковое значение с коэффициентом запаса 2 |
|-------------------------------------------|------|------------------|------------------------------------------|
| Поиск товаров                             | 387  | 642              | 774                                      |
| Добавление товаров в корзину              | 2.9  | 4.8              | 5.8                                      |
| Оформление заказов                        | 13.5 | 22.4             | 27                                       |
| Оставление отзывов                        | 96.8 | 160.7            | 193.6                                    |
| Управление учетной записью                | 20   | 32.3             | 40.6                                     |
| Управление заказами                       | 10   | 16.1             | 20.2                                     |
| Рекомендации товаров в ленте              | 100  | 161.4            | 200.4                                    |
| **Итого**        | 630.2| 1039.7           | 1261.6                                   |

<h2 id="3">3 Глобальная балансировка нагрузки</h2>

### География пользователей

Целевая аудитория Яндекс Маркета распределена по странам СНГ, с преобладанием в России. Вот как распределяются пользователи по регионам:

Страна       | Процентное соотношение
-------------| ----------------------
Россия       | 84.8%
Азербайджан     | 3.1% 
Китай    | 1.4%
Казахстан       | 1.2% 

Это определяет необходимость расположения датацентров (ДЦ) преимущественно в России и других странах СНГ для обеспечения низкой задержки и высокой производительности.

### Функциональное разбиение по доменам

Для оптимизации работы и распределения нагрузки по различным функциональным модулям можно применить функциональное разбиение по доменам. Это позволяет отдельным частям системы работать независимо друг от друга, улучшая масштабируемость и отказоустойчивость.

Примеры функциональных доменов:

* market.yandex.ru — API-сервисы для мобильных приложений и веб-версии.
* mc.yandex.ru — доставка медиа-контента (фото товаров, видео, баннеры).

Такое разбиение позволяет улучшить управляемость трафика, распределять нагрузку на отдельные системы, а также внедрять более гибкие методы балансировки.

### Обоснование расположения ДЦ

На основе (https://telegra.ph/Gde-data-centry-YAndeksa-03-07), [склады](https://yandex.ru/maps/?from=mapframe&ll=52.821695%2C53.073344&mode=usermaps&source=mapframe&um=constructor%3Acbecbebc1953af83c4a0453d8ace4feb7dc239f35d3278858320e5e86909535d&utm_source=mapframe&z=5.86) и [ПВЗ](https://yandex.ru/maps/?ll=91.148707%2C60.336308&mode=search&sctx=ZAAAAAgBEAAaKAoSCZ5eKcsQz0JAEdOgaB7A4EtAEhIJA137Anqh8j8RmPxP%2Fu4d7D8iBgABAgMEBSgKOABA4QFIAWoCcnWdAc3MzD2gAQCoAQC9AUi2ORzCAZIBieaipIME2ezzwqcBr6TszPMDitXvyckD7LrwnZ4G7deH0pUD9cnavIIH9ru3oo4Dzv6nl58F7%2FSv2OsD686Zr%2B0CiZX99mOP8OCVsAWpo9PI3AbI%2Bd%2B6oALm0OywvgbN7P2ZqwWWkZnrVsyR1KM%2Fivnh2NgCyvae27UGscn6yKQBsfvy4fYEmLeSkzf6uu7YmQOCAkPQv9GD0L3QutGC0Ysg0LLRi9C00LDRh9C4INGP0L3QtNC10LrRgSDQvNCw0YDQutC10YIg0L3QsCDQutCw0YDRgtC1igIAkgIAmgIMZGVza3RvcC1tYXBzqgIZMTM5NzIyMjgxMTE5LDIzNzkyMzg3NjQ5NrACAQ%3D%3D&sll=91.148707%2C60.336308&sspn=124.433297%2C36.312187&text=пункты%20выдачи%20яндекс%20маркет%20на%20карте&z=4.22) можно обосновать расположение датацентров. Основная цель — снизить сетевые задержки и улучшить производительность для конечных пользователей.

Страна    | Локация ДЦ                | Обоснование
----------| --------------------------| ---------------------------------------------------------------------------
Россия    |	Москва и подмосковье	  | 95.7% пользователей из России, оптимизация для западной части страны и Европы
Россия   |	       Санкт-Петербург          | Поддержка пользователей из Северной части Росии
Россия    |	Калуга	 | Поддержка основных пользователей западной части России и Европы
Россия    |	Новосибирск	 | Покрытие для пользователей Центральной России, Урала, Сибири
Россия  |	Владимирская область | Поддержка основных пользователей западной части России и Европы


Основное внимание уделяется России, так как большинство пользователей находится в этой стране. Однако наличие датацентров в соседних странах (Казахстан) помогает улучшить доступ к сервису и уменьшить задержки для пользователей этих регионов.

### Расчет распределения запросов по типам

На основе данных о нагрузке и географии пользователей можно рассчитать распределение запросов по типам для каждого датацентра.

Тип запроса                  |	RPS (Запад России) |	RPS (Центр России) |	RPS (Север)	| 
-----------------------------| -------------------| -------------------|---------------|
Поиск товаров                |	580.4             |	116.1                          |	30.96
Добавление товаров в корзину |	4.35            |	0.86                          | 0.232 
Оформление заказов           |	10.12             |	2.02                           |	0.5  
Оставление отзывов           |	72.6             |	14.52                          |	2.9  
Итого                        |	667.51           |	133.87                       |	34.6   

Общая нагрузка распределена пропорционально процентному соотношению пользователей в каждом регионе. Запад России несет наибольшую нагрузку, следом идут центральные регионы России.

### Схема DNS-балансировки

DNS-балансировка позволяет распределять трафик на уровне DNS-запросов, направляя пользователей к наиболее подходящему датацентру в зависимости от их географического местоположения.

Пример работы DNS-балансировки:
1. Пользователь из России отправляет запрос на market.yandex.ru.
2. DNS-сервер будет направлять пользователей на ближайший ДЦ с учетом их географического расположения. Для пользователей в центральной России и Сибири трафик будет перенаправляться в Новосибирск, а пользователи из западной части России будут обслуживаться в Москве и подмосковье.

### Схема Anycast-балансировки

Anycast-балансировка позволяет направлять запросы к ближайшему датацентру с минимальной задержкой. Использование Anycast помогает автоматически балансировать нагрузку на основе топологии сети и состояния датацентров.

Пример Anycast-балансировки:
1. Пользователь отправляет запрос на market.yandex.ru.
2. Протокол Anycast направляет запрос в ближайший CDN-сервер (например, в Москве, если пользователь из России).
3. Если датацентр перегружен или недоступен, Anycast перенаправляет запрос к следующему ближайшему датацентру, например, в Китай.

### Механизм регулировки трафика между ДЦ

Для динамической балансировки нагрузки между датацентрами можно использовать такие механизмы, как:
1. Routing — направляет пользователей в ближайший датацентр на основе географической локации. Данный способ будет предпочтительней чем GeoDNS, так как в основном вся аудитория находится внутри однойстраны - России.
2. Мониторинг нагрузки — автоматическая оценка текущей загрузки ДЦ и переключение на менее загруженные датацентры в случае перегрузки.
3. Технология GSLB (Global Server Load Balancing) — глобальное распределение запросов между датацентрами с учетом нагрузки, доступности и производительности каждого ДЦ.


<h2 id="4">4 Локальная балансировка нагрузки</h2>

### Архитектура локальной балансировки

Для обеспечения высокой доступности и отказоустойчивости используется многоуровневая архитектура балансировки. Она включает входной уровень (Edge Load Balancers) и внутренний уровень (Local Load Balancers), каждый из которых выполняет определенные задачи.

### 4.1 Входной уровень: балансировщики NGINX

**Роль:** Обработка всех внешних запросов к системе, включая терминацию SSL и распределение нагрузки на внутренние балансировщики.

**Ключевые технологии:**  
- **NGINX**: Используется в качестве обратного прокси и балансировщика нагрузки.

**Алгоритмы распределения нагрузки:**  
- **Round Robin**: Для равномерного распределения запросов.  
- **Least Connections**: Направление запросов на узел с наименьшим количеством активных подключений.  
- **IP Hash**: Обеспечение привязки пользователя к определенному серверу.

**Механизмы отказоустойчивости:**  
- **Failover**: Использование резервных экземпляров балансировщиков.  
- **Виртуальные IP-адреса**: Конфигурация VIP для автоматического переключения на доступные узлы.

**Пример процесса:**  
1. Пользовательский запрос поступает на один из балансировщиков NGINX.  
2. Производится терминация SSL, после чего запрос передается на внутренний уровень балансировки.  
3. Алгоритм распределения определяет, какой из внутренних балансировщиков обработает запрос.

### 4.2 Внутренний уровень: балансировщики Istio

**Роль:** Управление трафиком между микросервисами, учет их состояния и нагрузки.

**Ключевые технологии:**  
- **Istio**: Реализация Service Mesh для динамической маршрутизации запросов.

**Алгоритмы распределения нагрузки:**  
- **Dynamic Load Balancing**: Автоматическое перенаправление трафика на узлы с наименьшей нагрузкой.  
- **Weighted Round Robin**: Учет производительности узлов при распределении.

**Пример процесса:**  
1. Внутренний балансировщик получает запрос от входного уровня.  
2. На основе текущей нагрузки и состояния микросервисов запрос маршрутизируется к конкретной службе.  
3. Метрики производительности и отказоустойчивости учитываются в режиме реального времени.

**Механизмы отказоустойчивости:**  
- Использование Health Checks для проверки работоспособности сервисов.  
- Перенаправление трафика на активные микросервисы в случае сбоя.

### 4.3 Связь между уровнями

- **L4 и L7 протоколы:** Входные балансировщики могут работать на уровне транспортных соединений (L4) или анализировать содержимое запросов (L7) для маршрутизации.  
- **Service Mesh:** Обеспечивает связность, гибкость маршрутизации и мониторинг состояния на внутреннем уровне.
- На входном уровне несколько экземпляров NGINX обеспечивают балансировку и отказоустойчивость с помощью Keepalived.
- На уровне межсервисных запросов применяется балансировка L4 с IP Tunneling, что обеспечивает эффективное взаимодействие между микросервисами.

### 4.4 Расчет нагрузки

**Пример для SSL-терминации:**  
- Для каждого экземпляра NGINX определяется максимальное количество операций расшифровки SSL.  
- Мониторинг с использованием `ssl_handshake_time` позволяет оценить пиковую нагрузку.  
- В случае необходимости применяется аппаратное ускорение для разгрузки CPU.

### Преимущества

- Высокая отказоустойчивость за счет горизонтального масштабирования.  
- Гибкость маршрутизации благодаря алгоритмам динамической балансировки.  
- Снижение нагрузки на backend за счет терминации SSL на входном уровне.

### Применяемые технологии

- **NGINX:** Входной уровень балансировки.  
- **Istio:** Внутренний уровень и маршрутизация межсервисного трафика.  
- **Kubernetes:** Оркестрация контейнеров и масштабирование.  
- **Prometheus и Grafana:** Мониторинг состояния и производительности.

<h2 id="5">5 Логическая схема БД</h2>

Схема БД:
![image](/imgs/ya-market-logic.png)

### Описание таблиц базы данных

| **Таблица**          | **Поле**           | **Тип данных**      | **Описание**                                                  | **Размер данных (в байтах)** |
|----------------------|--------------------|---------------------|---------------------------------------------------------------|-----------------------------|
| **Profile**          | ProfileId          | integer, pk         | Уникальный идентификатор профиля (автоинкремент).              | 4                           |
|                      | Mail               | varchar(50)         | Электронная почта пользователя.                               | 50                          |
|                      | Name               | varchar(20)         | Имя пользователя.                                             | 20                          |
|                      | Password           | varchar(60)         | Хешированный пароль пользователя.                             | 60                          |
| **Итого**            |                    |                     |                                                               | **134 байта**               |
| **Address**          | AddressId          | integer, pk         | Уникальный идентификатор адреса (автоинкремент).               | 4                           |
|                      | location           | varchar(200)        | Адрес доставки.                                               | 200                         |
|                      | ProfileId          | integer, fk         | Связь с таблицей Profile через ProfileId.                     | 4                           |
| **Итого**            |                    |                     |                                                               | **208 байт**                |
| **Order**            | OrderId            | integer, pk         | Уникальный идентификатор заказа (автоинкремент).               | 4                           |
|                      | CreatedAt          | timestamp           | Время создания заказа.                                        | 8                           |
|                      | AddressId          | integer, fk         | Связь с таблицей Address через AddressId.                     | 4                           |
|                      | PaidAt             | timestamp           | Время оплаты заказа.                                          | 8                           |
|                      | Status             | varchar(20)         | Статус заказа.                                                | 20                          |
|                      | Delivery           | boolean             | Указывает, требуется ли доставка.                             | 1                           |
| **Итого**            |                    |                     |                                                               | **45 байт**                 |
| **Product**          | SKU                | integer, pk         | Уникальный идентификатор продукта (автоинкремент).             | 4                           |
|                      | Name               | varchar(100)        | Название продукта.                                            | 100                         |
|                      | Price              | integer             | Цена продукта.                                                | 4                           |
|                      | Description        | varchar(2000)       | Описание продукта.                                            | 2000                        |
|                      | Sizes              | varchar(40)         | Размеры продукта.                                             | 40                          |
|                      | Weight             | varchar(10)         | Вес продукта.                                                 | 10                          |
|                      | WarrantyDays       | date                | Срок гарантии продукта.                                       | 3                           |
|                      | Color              | varchar(20)         | Цвет продукта.                                                | 20                          |
|                      | OrderId            | integer, fk         | Связь с таблицей Order через OrderId.                         | 4                           |
|                      | Rate               | float               | Рейтинг продукта                                              | 8                           |
| **Итого**            |                    |                     |                                                               | **2185 байт**               |
| **ProfileProduct**         | ProfileId         | integer, pk fk        | Связь с таблицей Profile через ProfileId.            | 4                           |
|                      | ProductId         | integer, pk fk        | Связь с таблицей Product через ProducteId.            | 4                           |
| **Итого**            |                    |                     |                                                               | **8 байт**                 |
| **Category**         | CategoryId         | integer, pk         | Уникальный идентификатор категории (автоинкремент).            | 4                           |
|                      | Name               | varchar(20)         | Название категории.                                           | 20                          |
|                      | ParentId           | integer, fk         | Связь с таблицей Category через CategoryId (для подкатегорий). | 4                           |
| **Итого**            |                    |                     |                                                               | **28 байт**                 |
| **MediaFile**        | MediaFileId        | integer, pk         | Уникальный идентификатор медиафайла (автоинкремент).           | 4                           |
|                      | Type               | varchar(10)         | Тип медиафайла (например, изображение, видео).                | 10                          |
|                      | RelativeUrl        | varchar(40)         | URL для доступа к файлу.                                      | 40                          |
| **Итого**            |                    |                     |                                                               | **54 байта**                |
| **PostOffice**       | PostOfficeId       | integer, pk         | Уникальный идентификатор почтового отделения (автоинкремент).  | 4                           |
|                      | location           | varchar(200)        | Адрес почтового отделения.                                    | 200                         |
|                      | WorkTime           | varchar(200)        | Время работы почтового отделения.                             | 200                         |
| **Итого**            |                    |                     |                                                               | **404 байта**               |
| **FeedBack**         | FeedBackId         | integer, pk         | Уникальный идентификатор отзыва (автоинкремент).               | 4                           |
|                      | ProductId          | integer, fk         | Связь с таблицей Product через SKU.                           | 4                           |
|                      | ProfileId          | integer, fk         | Связь с таблицей Profile через ProfileId.                     | 4                           |
|                      | CreatedAt          | timestamp           | Время создания отзыва.                                        | 8                           |
|                      | Payload            | varchar(200)        | Текст отзыва.                                                 | 200                         |
|                      | Rate               | integer             | Оценка продукта (1-5).                                        | 4                           |
| **Итого**            |                    |                     |                                                               | **224 байта**               |
| **Session**	|SessionId |	integer, pk | 	Уникальный идентификатор сессии (автоинкремент). |	4 |
| | ProfileId |	integer, fk |	Связь с таблицей Profile через ProfileId.	| 4 |
| | CreatedAt |	timestamp |	Время создания сессии. |	8 |
| | ExpiresAt | 	timestamp	 | Время истечения сессии. | 	8  |
| | Token | 	varchar(255) | 	Уникальный токен для идентификации сессии. |	255 |
| |  IsActive | 	boolean	| Указывает, активна ли сессия. | 	1  |
| **Итого** |                    |                     |                                                               |			**280 байт** |

#### Общий расчет объема хранения для таблиц Яндекс Маркета

Исходные данные:

- **Количество пользователей (Profile)**: 18.2 млн
- **Количество товаров (Product)**: 108 млн
- **Количество заказов (Order)**: 130 млн
- **Количество категорий (Category)**: 50 тыс
- **Количество медиафайлов (MediaFile)**: 200 млн
- **Количество отзывов (FeedBack)**: 500 млн
- **Количество сессий (Session)**: 100 млн
- **Количество адресов (Address)**: предположим, 3 адресса на пользователя = 54,6 млн
- **Количество связей продукт-категория (ProductCategory)**: предположим, 3 категории на продукт = 324 млн

#### Profile
- **Количество записей**: 18.2 млн
- **Размер одной записи**: 134 байта

Общий размер таблицы Profile = 18.2 млн * 134 байт = 2,438,800,000 байт ≈ 2.44 ГБ

#### Profile
- **Количество записей**: 18.2 млн
- **Размер одной записи**: 134 байта

Общий размер таблицы Profile = 18.2 млн * 134 байт = 2,438,800,000 байт ≈ 2.44 ГБ

#### Order
- **Количество записей**: 130 млн
- **Размер одной записи**: 45 байт

Общий размер таблицы Order = 130 млн * 45 байт = 5,850,000,000 байт ≈ 5.85 ГБ


#### Product
- **Количество записей**: 108 млн
- **Размер одной записи**: 2185 байт

Общий размер таблицы Product = 108 млн * 2185 байт = 235,980,000,000 байт ≈ 235.98 ГБ


#### Category
- **Количество записей**: 50 тыс
- **Размер одной записи**: 28 байт

Общий размер таблицы Category = 50 тыс * 28 байт = 1,400,000 байт ≈ 1.4 МБ

#### MediaFile
- **Количество записей**: 200 млн
- **Размер одной записи**: 54 байта

Общий размер таблицы MediaFile = 200 млн * 54 байт = 10,800,000,000 байт ≈ 10.8 ГБ

#### FeedBack
- **Количество записей**: 500 млн
- **Размер одной записи**: 224 байта

Общий размер таблицы FeedBack = 500 млн * 224 байт = 112,000,000,000 байт ≈ 112 ГБ

#### Session
- **Количество записей**: 100 млн
- **Размер одной записи**: 280 байт

Общий размер таблицы Session = 100 млн * 280 байт = 28,000,000,000 байт ≈ 28 ГБ


### Требования к консистентности
В зависимости от типов данных и природы приложения, можно выделить следующие требования к консистентности:

- Сессии (Session): требуется строгая консистентность, так как данные о сессиях пользователей используются для аутентификации и управления доступом. Важно, чтобы сессия создавалась, обновлялась или завершалась в реальном времени, без задержек.
- Заказы (Order): требуется строгая консистентность для подтверждения и оплаты заказов. Примером могут быть транзакции для изменения статусов заказа (оплачен/не оплачен) с проверкой целостности данных.
- Отзывы (FeedBack): консистентность важна, но допустимо использование eventual consistency, когда данные о новых отзывах могут быть слегка отложены, например, при использовании асинхронных операций для хранения отзывов и изображений.
- Продукты и Категории: данные о продуктах и категориях должны быть консистентными при добавлении, удалении или изменении, чтобы обеспечить корректную классификацию товаров.
### Особенности распределения нагрузки по ключам
Для эффективного распределения нагрузки и использования ключей важно:

- Profile/ProfileId: равномерное распределение ключей на уровне профилей, чтобы избежать перегрузки одного сегмента. Шардирование может основываться на диапазонах ProfileId.
- Order/OrderId: важно сбалансированное распределение ключей по времени создания заказа, что особенно актуально для высоконагруженных систем. Здесь можно использовать подходы time-based шардирования для улучшения распределения.
- Product/SKU: шардирование по идентификаторам товаров должно учитывать возможность частых запросов к популярным товарам, чтобы избегать перегрузки одного шарда.
- Session/SessionId: сессии можно шардировать по SessionId или по времени создания, чтобы равномерно распределить активные сессии между различными серверами, особенно при высоком количестве одновременных пользователей
### Размеры данных и нагрузка на чтение/запись
Для оценки нагрузки на чтение и запись, необходимо учитывать следующие моменты:

- Profile: загрузка профилей будет регулярной, однако обновление будет редким, что снижает нагрузку на запись.
- Order: система должна быть оптимизирована на частую запись и чтение, поскольку создание и обновление заказов происходит часто.
- Product: информация о продуктах чаще всего читается, чем обновляется, поэтому можно использовать кэширование.
- FeedBack: данные отзывов тоже можно кэшировать, так как это в основном запросы на чтение.
- Session: данные сессий требуют быстрого чтения и записи для поддержки текущих сессий пользователей. Однако данные сессий могут устаревать, поэтому можно внедрить механизм автоматической очистки старых или неактивных сессий для экономии ресурсов.

<h2 id="6">6 Физическая схема БД </h2>

Схема БД:

![image](/imgs/physical.drawio.png)


### Описание таблиц базы данных

| **Таблица**          | **Поле**           | **Тип данных**      | **Описание**                                                  | **Размер данных (в байтах)** |
|----------------------|--------------------|---------------------|---------------------------------------------------------------|-----------------------------|
| **Profile**          | ProfileId          | integer, pk         | Уникальный идентификатор профиля (автоинкремент).              | 4                           |
|                      | Mail               | varchar(50)         | Электронная почта пользователя.                               | 50                          |
|                      | Name               | varchar(20)         | Имя пользователя.                                             | 20                          |
|                      | Password           | varchar(60)         | Хешированный пароль пользователя.                             | 60                          |
| **Итого**            |                    |                     |                                                               | **134 байта**               |
| **Address**          | AddressId          | integer, pk         | Уникальный идентификатор адреса (автоинкремент).               | 4                           |
|                      | location           | varchar(200)        | Адрес доставки.                                               | 200                         |
|                      | ProfileId          | integer, fk         | Связь с таблицей Profile через ProfileId.                     | 4                           |
| **Итого**            |                    |                     |                                                               | **208 байт**                |
| **Order**            | OrderId            | integer, pk         | Уникальный идентификатор заказа (автоинкремент).               | 4                           |
|                      | CreatedAt          | timestamp           | Время создания заказа.                                        | 8                           |
|                      | AddressId          | integer, fk         | Связь с таблицей Address через AddressId.                     | 4                           |
|                      | PaidAt             | timestamp           | Время оплаты заказа.                                          | 8                           |
|                      | Status             | varchar(20)         | Статус заказа.                                                | 20                          |
|                      | Delivery           | boolean             | Указывает, требуется ли доставка.                             | 1                           |
|                      | OrderPrice           | integer             | Цена доставки.                             | 4                           |
|                      | PostOfficeId       | integer, fk         | Связь с таблицей PostOffice через PostOfficeId.               | 4                           |
| **Итого**            |                    |                     |                                                               | **53 байт**                 |
| **Product**          | SKU                | integer, pk         | Уникальный идентификатор продукта (автоинкремент).             | 4                           |
|                      | Name               | varchar(100)        | Название продукта.                                            | 100                         |
|                      | Price              | integer             | Цена продукта.                                                | 4                           |
|                      | Description        | varchar(2000)       | Описание продукта.                                            | 2000                        |
|                      | Sizes              | varchar(40)         | Размеры продукта.                                             | 40                          |
|                      | Weight             | varchar(10)         | Вес продукта.                                                 | 10                          |
|                      | WarrantyDays       | date                | Срок гарантии продукта.                                       | 3                           |
|                      | Color              | varchar(20)         | Цвет продукта.                                                | 20                          |
|                      | Rate               | float               | Рейтинг продукта                                              | 8                           |
|                      | Categories         | [] varchar(20)               | Денормализованное поле для хранения категорий продукта               | 8                           |
|                      | OrderId            | integer, fk         | Связь с таблицей Order через OrderId.                         | 4                           |
| **Итого**            |                    |                     |                                                               | **2193 байт**               |
| **ProfileProduct**         | ProfileId         | integer, pk fk        | Связь с таблицей Profile через ProfileId.            | 4                           |
|                      | ProductId         | integer, pk fk        | Связь с таблицей Product через ProducteId.            | 4                           |
| **Итого**            |                    |                     |                                                               | **8 байт**                 |
| **Category**         | CategoryId         | integer, pk         | Уникальный идентификатор категории (автоинкремент).            | 4                           |
|                      | Name               | varchar(20)         | Название категории.                                           | 20                          |
|                      | ParentId           | integer, fk         | Связь с таблицей Category через CategoryId (для подкатегорий). | 4                           |
| **Итого**            |                    |                     |                                                               | **28 байт**                 |
| **ProductCategory**  | ProductId          | integer, fk, pk     | Связь с таблицей Product через SKU.                           | 4                           |
|                      | CategoryId         | integer, fk, pk     | Связь с таблицей Category через CategoryId.                   | 4                           |
| **Итого**            |                    |                     |                                                               | **8 байт**                  |
| **OrderProduct**     | OrderId            | integer, fk, pk     | Связь с таблицей Order через OrderId.                         | 4                           |
|                      | ProductId          | integer, fk, pk     | Связь с таблицей Product через SKU.                           | 4                           |
| **Итого**            |                    |                     |                                                               | **8 байт**                  |
| **MediaFile**        | MediaFileId        | integer, pk         | Уникальный идентификатор медиафайла (автоинкремент).           | 4                           |
|                      | Type               | varchar(10)         | Тип медиафайла (например, изображение, видео).                | 10                          |
|                      | RelativeUrl        | varchar(40)         | URL для доступа к файлу.                                      | 40                          |
|                      | ProductId          | integer, fk, pk     | Связь с таблицей Product через SKU.                           | 4                           |
|                      | Position           | integer             | Порядок отображения медиафайлов.                              | 4                           |
| **Итого**            |                    |                     |                                                               | **62 байта**                |
| **PostOffice**       | PostOfficeId       | integer, pk         | Уникальный идентификатор почтового отделения (автоинкремент).  | 4                           |
|                      | location           | varchar(200)        | Адрес почтового отделения.                                    | 200                         |
|                      | WorkTime           | varchar(200)        | Время работы почтового отделения.                             | 200                         |
| **Итого**            |                    |                     |                                                               | **404 байта**               |
| **FeedBack**         | FeedBackId         | integer, pk         | Уникальный идентификатор отзыва (автоинкремент).               | 4                           |
|                      | ProductId          | integer, fk         | Связь с таблицей Product через SKU.                           | 4                           |
|                      | ProfileId          | integer, fk         | Связь с таблицей Profile через ProfileId.                     | 4                           |
|                      | CreatedAt          | timestamp           | Время создания отзыва.                                        | 8                           |
|                      | Payload            | varchar(200)        | Текст отзыва.                                                 | 200                         |
|                      | Rate               | integer             | Оценка продукта (1-5).                                        | 4                           |
| **Итого**            |                    |                     |                                                               | **224 байта**               |
| **Session**	         |SessionId           |	        integer, pk | 	           Уникальный идентификатор сессии (автоинкремент). |                          	4 |
|                      | ProfileId          |	integer, fk         |	Связь с таблицей Profile через ProfileId.                     |                           4 |
|                      |          CreatedAt |          	timestamp |	                                       Время создания сессии. |	                          8 |
|                      |          ExpiresAt |        	timestamp	  |                                       Время истечения сессии. |                          	8 |
|                      | Token              |      	varchar(255)  | 	                 Уникальный токен для идентификации сессии. |	                        255 |
|                      |            IsActive| 	          boolean	|                                 Указывает, активна ли сессия. |                        	1   |
| **Итого** |                    |                     |                                                               |			**280 байт** |
| **ProductElasticSearch** | ProductId       | integer, pk           | Уникальный идентификатор продукта.                   | 4                            |
|                          | Name            | text                  | Название продукта.                                   | 50                           |
|                          | Description     | text                  | Описание продукта.                                   | 200                          |
|                          | Categories      | [] text               | Массив категорий продукта (3 категории по 20 символов). | 60                           |
|                          | Price           | integer               | Цена продукта.                                       | 4                            |
|                          | Rate            | float                 | Рейтинг продукта.                                    | 8                            |
|                          | Color           | text                  | Цвет продукта (средняя длина 10 символов).           | 10                           |
| **Итого**               |                 |                       |                                                      | **336 байт**                 |
| **FeedBackElasticSearch** | FeedBackId     | integer, pk           | Уникальный идентификатор отзыва.                     | 4                            |
|                           | ProductId      | integer, fk           | Идентификатор продукта.                              | 4                            |
|                           | ProfileId      | integer, fk           | Идентификатор пользователя.                          | 4                            |
|                           | Rate           | integer               | Оценка продукта.                                     | 4                            |
| **Итого**                 |                |                       |                                                      | **16 байт**                 |


### Оптимизация базы данных: Индексы, денормализация и масштабирование

1. Индексы
- **Profile.Mail** — необходимо создать уникальный индекс, так как поле может использоваться для аутентификации и поиска профилей.
- **Order.CreatedAt**, **Order.Status** — индексация для ускорения запросов на фильтрацию заказов по дате создания или статусу.
- **Product.Name** — индекс для ускорения поиска по названию товаров.
- **Category.Name** — так как часто используется поиск или фильтрация по категориям.
- **FeedBack.ProductId** и **FeedBack.ProfileId** — индексация для связи с продуктами и пользователями.
- **Session.Token** — уникальный индекс для быстрого поиска активных сессий по токенам.

2. Выбор СУБД (потаблично)
  
| **Таблица**             | **Описание**                                                                                   | **Выбор СУБД**                           |
|--------------------------|-----------------------------------------------------------------------------------------------|------------------------------------------|
| **Profile**              | Содержит информацию о профилях пользователей, включая email, имя и пароль.                    | PostgreSQL                               |
| **Address**              | Хранит данные о адресах доставки, привязанных к профилям пользователей.                       | PostgreSQL                               |
| **Order**                | Содержит информацию о заказах, включая дату создания, статус, адрес доставки и постамат.       | PostgreSQL                               |
| **Product**              | Информация о продуктах: название, цена, описание.                                             | PostgreSQL                               |
| **ProductElasticSearch** | Информация, необходимая для полнотекстового поиска по товарам.                                | Elasticsearch                            |
| **Category**             | Иерархическая структура категорий товаров, может иметь вложенные подкатегории.                | PostgreSQL                               |
| **ProductCategory**      | Связь между товарами и категориями для быстрой фильтрации.                                    | PostgreSQL                               |
| **ProductProfile**       | Связь между товарами и пользователями для функции сравнения товаров.                          | PostgreSQL                               |
| **OrderProduct**         | Связь между заказами и товарами для хранения списка товаров в заказе.                         | PostgreSQL                               |
| **MediaFile**            | Хранит метаданные медиафайлов (тип файла и URL) для продуктов и отзывов.                      |  AWS S3                                  |
| **ProductMedia**         | Связь между товарами и медиафайлами для хранения изображений или видео.                       | PostgreSQL                               |
| **PostOffice**           | Содержит информацию о постаматах, включая местоположение и рабочее время.                     | PostgreSQL                               |
| **FeedBack**             | Хранит отзывы пользователей о товарах с текстом и рейтингом.                                  | MongoDB                                  |
| **FeedBackElasticSearch**| Информация, для быстрого поиска отзывов или оценок товаров.                                   | Elasticsearch                            |
| **Session**              | Информация о сессиях пользователей: токен, время создания, истечения и активность.            | Redis                                    |


3. Шардирование и резервирование СУБД (потаблично)
- **Profile, Order**  
  - **Шардирование:** Горизонтальное по идентификатору пользователя или региону для равномерного распределения нагрузки.
  - **Резервирование:** Использовать primary-replica репликацию для отказоустойчивости: мастер принимает записи, реплики обслуживают чтение.

- **FeedBack, MediaFile**  
  - **Шардирование:** По `ProductId` для равномерного распределения данных.
  - **Резервирование:** Репликация MongoDB через Replica Sets для автоматического failover.

- **Session**  
  - **Шардирование:** Redis шардирует данные по `SessionId`. Шардирование по времени создания подходит при равномерных нагрузках.
  - **Резервирование:** Redis Cluster обеспечивает отказоустойчивость.


4. Клиентские библиотеки / интеграции
- **PostgreSQL** — `psycopg2` (Python), `Sequelize` (Node.js), `SQLAlchemy` (Python).
- **NoSQL (MongoDB)** — `pymongo` (Python), `Mongoose` (Node.js).
- **Redis** — интеграция для кэширования и хранения сессий.
- **Elasticsearch** — для сложного поиска и фильтрации данных.

5. Балансировка запросов / мультиплексирование подключений
- **PgBouncer** для PostgreSQL: это решение для подключения к нескольким инстансам базы данных и балансировки запросов между ними.
- **NGINX** можно использовать для балансировки запросов на уровне веб-серверов, распределяя запросы к разным инстансам базы данных.

6. Схема резервного копирования
- **PostgreSQL**: использовать **pg_dump** для периодического создания бэкапов с последующим хранением на внешних серверах.
- **NoSQL** (MongoDB): использовать **mongodump** для регулярного копирования данных.
- **Ротация бэкапов**: хранить ежедневные бэкапы за последнюю неделю, еженедельные за последний месяц и ежемесячные за последний год.
- Внедрение стратегии горячих и холодных резервных копий для минимизации времени простоя при восстановлении.
- **Горячие и холодные копии**: Горячие копии для быстрого восстановления, холодные для долгосрочного хранения.

<h2 id="7">7 Алгоритмы</h2>

### Система сбора и хранения метрик для рекомендаций
Основные задачи системы включают сбор метрик, мониторинг производительности и хранение данных взаимодействия пользователей для улучшения качества рекомендаций. 

Метрики помогают оптимизировать алгоритмы рекомендаций, отслеживать изменения в реальном времени и выявлять потенциальные узкие места в системе. В этом документе представлены подходы к мониторингу, кэшированию, хранению и обработке данных для построения эффективной системы рекомендаций.

#### 1. Технологии для сбора метрик

Для мониторинга и сбора метрик системы рекомендуется использовать **Prometheus** и **Grafana**:

- **Prometheus**: Основной инструмент для сбора метрик в реальном времени, интегрируемый с микросервисами с помощью `Prometheus Exporter`.
  - **Поддержка метрик**: Метрики производительности (RPS, задержка отклика модели), точности (CTR — соотношение кликов к просмотрам) и надежности (ошибки в предсказаниях).
  - **Особенности хранения**: Prometheus сохраняет данные как временные ряды, что позволяет анализировать их с течением времени.

- **Grafana**: Визуализация метрик Prometheus с помощью дашбордов.
  - **Пример дашбордов**: Метрики успешных рекомендаций, процент ошибок предсказания, загрузка базы данных, среднее время отклика, количество запросов в минуту.
  - **Алерты**: Позволяет настраивать оповещения об отклонениях от SLA (например, превышение порога задержки) или других аномалиях.

#### 2. Хранение данных для рекомендаций

Для хранения данных о взаимодействиях пользователей с продуктами, результатах рекомендаций и исторических данных используются дополнительные таблицы базы данных, такие как `UserActivityMetrics` и `RecommendationMetrics`. Эти таблицы хранят данные об активности пользователя (просмотры, клики, покупки), а также метрики, связанные с рекомендациями (время отклика модели, список рекомендованных продуктов).

| Таблица                  | Поле                  | Тип данных    | Описание                                                            |
|-------------------------|----------------------|---------------|---------------------------------------------------------------------|
| **UserActivityMetrics**  | ActivityId           | SERIAL        | Уникальный идентификатор активности                                  |
|                         | UserId               | INTEGER       | Идентификатор пользователя (внешний ключ из таблицы Profile)       |
|                         | ProductId            | INTEGER       | Идентификатор продукта (внешний ключ из таблицы Product)           |
|                         | ActivityType         | VARCHAR(20)   | Тип активности: "view", "click", "purchase"                        |
|                         | Timestamp            | TIMESTAMP     | Дата и время активности                                             |
| **RecommendationMetrics** | RecId                | SERIAL        | Уникальный идентификатор рекомендации                                |
|                         | UserId               | INTEGER       | Идентификатор пользователя (внешний ключ из таблицы Profile)       |
|                         | RecommendedProducts   | JSONB         | JSON со списком рекомендованных продуктов                           |
|                         | ResponseTime         | FLOAT         | Время отклика модели (в миллисекундах)                             |
|                         | Timestamp            | TIMESTAMP     | Дата и время создания записи                                        |

#### 3. Подходы к кэшированию

Для повышения скорости работы системы и снижения нагрузки на базу данных используется кэширование:

- **Redis**: Хранение часто запрашиваемых данных, таких как популярные рекомендации или профили поведения пользователей.
- **Кэширование рекомендаций**: В Redis можно хранить рекомендации для каждого пользователя, обновляя данные по мере необходимости.

#### 4. Модели и алгоритмы для рекомендаций

Рекомендуемая модель рекомендаций в высоконагруженной системе использует:

- **Collaborative Filtering** и **Content-Based Filtering** для поиска похожих пользователей или продуктов.
- **Factorization Machines (FM)** или **Neural Collaborative Filtering (NCF)** для создания рекомендаций на основе комплексных паттернов.
- **Exploration-Exploitation** (например, ε-greedy или UCB) для учета новых данных в рекомендациях.

#### 5. Пример мониторинга и алертов с Prometheus и Grafana

Prometheus позволяет собирать метрики с базы данных и API. Примеры метрик для мониторинга:

- **Запросы на рекомендации в минуту (RPS)** для анализа нагрузки.
- **Средняя задержка отклика модели** для мониторинга производительности.
- **Процент успешных рекомендаций** для измерения эффективности.

Для настройки алертов в Grafana можно создать следующие условия:

- Уведомления, если **средняя задержка отклика** превышает 1000 мс.
- Оповещения, если **процент ошибок предсказаний** превышает 5%.

#### 6. Стратегия хранения и резервного копирования данных

Периодическое резервное копирование метрик и данных помогает избежать потерь при сбоях:

- **Резервные копии базы данных**: PostgreSQL можно использовать с инструментом `pg_dump` для создания резервных копий. Данные из таблиц с метриками можно хранить на отдельном сервере.
- **MongoDB** для резервного хранения массивов данных (например, истории рекомендаций или логов метрик).
- **Ротация бэкапов**: Хранить ежедневные бэкапы за последнюю неделю, еженедельные за последний месяц и ежемесячные за последний год.

<h2 id="8">8 Технологии</h2>

| Технология              | Область применения                        | Мотивационная часть                                                                                      |
|-------------------------|-------------------------------------------|----------------------------------------------------------------------------------------------------------|
| **DNS-балансировка**    | Распределение трафика на уровне DNS-запросов | Обеспечивает доступ к ближайшему датацентру с учетом географического расположения пользователя            |
| **Anycast-балансировка**| Направление запросов к ближайшему датацентру | Автоматически балансирует нагрузку на основе топологии сети и состояния датацентров                      |
| **Routing**             | Географическое распределение трафика       | Направляет пользователей в ближайший датацентр, предпочтительно в рамках одной страны                     |
| **Мониторинг нагрузки** | Автоматическая оценка загрузки ДЦ          | Позволяет переключать трафик на менее загруженные датацентры в случае перегрузки                          |
| **GSLB**                | Глобальное распределение запросов между ДЦ | Оптимизирует запросы, учитывая нагрузку и производительность каждого датацентра                           |
| **NGINX**               | Входной уровень балансировки               | Обеспечивает отказоустойчивость, терминацию SSL, начальное распределение нагрузки                         |
| **Istio**               | Внутренний уровень балансировки            | Управляет трафиком между микросервисами, учитывая их состояние и нагрузку                                 |
| **L4/L7 балансировка**  | Уровень транспортного и HTTP анализа       | Предоставляет возможность маршрутизации запросов по URL или на транспортном уровне                        |
| **IP Hash**             | Привязка пользователя к серверу           | Сохраняет пользователя на одном сервере, улучшая кэширование и стабильность сессии                        |
| **Weighted Round Robin**| Весовое распределение запросов             | Подходит для серверов с разной мощностью, распределяя нагрузку пропорционально их возможностям            |
| **SSL-ускорители**      | Аппаратное ускорение терминации SSL        | Уменьшает нагрузку на CPU при поддержке SSL-сессий                                                        |
| **Kubernetes**          | Управление межсервисным взаимодействием    | Позволяет автоматизировать развертывание и масштабирование микросервисов, повышая их доступность          |
| **TypeScript**   | Фронтенд                      | Преобразует JavaScript в статически типизированный язык, позволяя отлавливать ошибки на этапе разработки. Улучшает читаемость, поддержку кода и снижает количество багов, что способствует безопасности приложений. |
| **React**        | Фронтенд                      | Библиотека для построения пользовательских интерфейсов с высокой отзывчивостью и скоростью. Идеально подходит для SPA, поддерживает компоненты и эффективный рендеринг через Virtual DOM, повышая производительность и гибкость разработки. |
| **Kotlin**       | Мобильные приложения (Android) | Язык разработки Android-приложений с лаконичным и безопасным синтаксисом. Поддержка корутин позволяет легко реализовывать асинхронные операции, что делает его удобным для создания быстрореагирующих интерфейсов. |
| **Swift**        | Мобильные приложения (iOS)     | Основной язык для разработки iOS-приложений, интегрируется с iOS SDK, обеспечивая высокую производительность. Оптимизирован для создания современных и безопасных приложений с качественным UX. |
| **Golang**       | Бэкенд                        | Высокопроизводительный язык программирования, подходящий для создания масштабируемых сервисов. Поддерживает параллельные задачи, что делает его идеальным для серверных приложений под высокой нагрузкой. |
| **Prometheus**   | Сбор метрик                   | Система мониторинга и оповещений, оптимизированная для временных рядов данных. Позволяет отслеживать показатели производительности и состояния сервисов в режиме реального времени. |
| **Grafana**      | Визуализация метрик, мониторинг | Инструмент для визуализации метрик из различных источников (например, Prometheus) в виде графиков и дашбордов. Помогает инженерам мониторить состояние системы, выявлять проблемы и анализировать производительность. |
| **Istio**        | Внутренний Load Balancer       | Сервисная сетка для микроархитектурных приложений, обеспечивает балансировку, безопасность и мониторинг сервисов внутри системы. Позволяет управлять распределением трафика между микросервисами и улучшает отказоустойчивость. |
| **Redis**           | Хранилище сессий, кэширование            | База данных в оперативной памяти, которая обеспечивает быстрый доступ к данным. Подходит для кэширования и хранения временных данных, таких как сессии пользователей, за счет поддержки TTL (time-to-live) и механизма in-memory, что улучшает производительность. |
| **AWS S3**         | Хранилище файлов и резервное копирование | Облачное хранилище для долговременного хранения и резервного копирования данных. Предлагает высокий уровень доступности и надежности, автоматическую репликацию и интеграцию с другими сервисами AWS. |
| **PostgreSQL**      | Основная база данных                     | Надежная реляционная СУБД с поддержкой транзакций ACID, которая обеспечивает целостность данных, поддерживает сложные запросы и связи между таблицами. Подходит для хранения и обработки основной информации о пользователях, продуктах и заказах. |
| **ElasticSearch**   | Поисковый движок                         | Высокопроизводительный движок для полнотекстового поиска, позволяющий быстро и эффективно находить данные по ключевым словам и фильтрам. Это улучшает скорость поиска и облегчает работу с большим объемом данных. |

<h2 id="9">9 Обеспечение надёжности</h2>

### Сводная таблица резервирования компонентов системы

| Компонент            | Способ резервирования                                                                                                                                       |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **DNS-балансировка** | Настройка нескольких DNS-записей (многоуровневая отказоустойчивость), уменьшение TTL для быстрого обновления в случае сбоя                                   |
| **Anycast-балансировка** | Использование нескольких датацентров для маршрутизации к ближайшему узлу, автоматическое переключение при недоступности текущего центра                 |
| **Routing**          | Дублирование маршрутов для автоматического переключения в случае перегрузки, отказа или нарушения связи                                                    |
| **Мониторинг нагрузки** | Настройка резервных датацентров и гибкое переключение трафика при перегрузке, мониторинг и автоматическая реакция на загрузку                           |
| **GSLB**             | Резервирование политик маршрутизации (Active-Passive, Active-Active) для распределения запросов, использование failover для глобальных аварий              |
| **NGINX**            | Запуск нескольких экземпляров (инстансов) с автофейловером, резервное кэширование данных, распределение запросов между несколькими NGINX-серверами       |
| **Istio**            | Резервирование на уровне микросервисов (пул резервных подов), health checks и автоматическое переключение на доступные экземпляры                         |
| **L4/L7 балансировка** | Настройка нескольких балансировщиков с failover, перенаправление запросов к резервным серверам в случае перегрузки                                      |
| **IP Hash**          | Переключение на резервный сервер при отказе основного, маршрутизация трафика через резервный балансировщик на уровне сессий                               |
| **Weighted Round Robin** | Настройка весов в зависимости от нагрузки и состояния серверов, автоматическое перенаправление на резервные узлы                                     |
| **SSL-ускорители**   | Резервные SSL-ускорители для обработки сессий при увеличении нагрузки, автоматический фейловер                                                            |
| **Kubernetes**       | Использование replica sets для обеспечения резервных подов, автошкалирование, регулярные health checks для резервирования подов                          |
| **TypeScript**       | Интеграция типов для предотвращения ошибок и отказоустойчивости, юнит-тестирование для резервирования логики                                              |
| **React**            | Кэширование компонентов и данных, использование резервных механизмов обработки ошибок (Error Boundaries)                                                 |
| **Kotlin**           | Асинхронная обработка с возможностью восстановления состояния при сбоях, кеширование данных, ретраи на запросах                                          |
| **Swift**            | Кэширование на устройстве, использование try-catch для критических операций, периодическое резервное копирование данных                                   |
| **Golang**           | Использование каналов для восстановления после сбоев, параллельные процессы с фейловером                                                                  |
| **Prometheus**       | Резервные экземпляры для сохранения метрик, дублирование алертов для повышения надежности и доступности                                                   |
| **Grafana**          | Настройка резервных экземпляров и бэкапов данных дашбордов для аварийного восстановления, дублирование ключевых алертов                                   |
| **Redis**            | Master-slave репликация для отказоустойчивости, использование кластера для резервирования данных                                                          |
| **AWS S3**           | Автоматическая репликация данных на несколько географически разнесенных узлов, версияция данных, шифрование и резервные копии                            |
| **PostgreSQL**       | Настройка репликации (Master-Slave или Master-Master), регулярное резервное копирование данных, шардирование для минимизации потерь                       |
| **ElasticSearch**    | Репликация данных между узлами для обеспечения отказоустойчивости, автоматическая перераспределение данных при отказе узлов                              |

### Источники надежности на физическом уровне

| Источник           | Описание                                                                                                                                                     |
|--------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Датацентры**     | Географически распределенные датацентры для минимизации потерь данных и повышения доступности                                                                 |
| **Резервные каналы связи** | Использование нескольких поставщиков интернет-услуг для устранения рисков отключений                                                                 |
| **Питание и UPS**  | Резервные источники питания и системы бесперебойного питания (UPS) для предотвращения сбоев при нарушении энергоснабжения                                     |
| **Дублирование оборудования** | Резервные серверы, хранилища и сетевые устройства для автоматического переключения при сбое основных компонентов                                   |
| **Мониторинг и предиктивное обслуживание** | Системы мониторинга с возможностью предсказания сбоев и своевременного обслуживания оборудования                                            |
| **Световые знаки и провода в серверной** | Использование знаков для опасных мест в серверной. Использование световых проводовов, чтобы лишний раз его не задеть при хождение в серверную                                            |

Для повышения отказоустойчивости минимум два датацентра в разных городах. Например:

- Основной датацентр в Москве или Московской области.
- Резервный датацентр в Санкт-Петербурге, Казани или Нижнем Новгороде.

Это распределение обеспечит быстрое переключение между датацентрами при сбоях и позволит эффективно покрывать западные и центральные регионы России.

### Graceful Degradation и Graceful Shutdown

| Механизм                    | Описание                                                                                                                                                     |
|-----------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Graceful Degradation**    | Поддержка базовой функциональности системы при частичных сбоях. Например, при потере одного из сервисов часть запросов перенаправляется на кэшированные данные |
| **Graceful Shutdown**       | Плавное завершение работы при отключении системы или её компонентов. Завершение обработки активных запросов и минимизация потерь                             |
| **Фейловер и ретраи**       | Автоматическое переключение на резервные компоненты и повторная отправка запросов в случае недоступности основных серверов                                   |
| **Load Shedding**           | Ограничение нагрузки на критичных участках, чтобы предотвратить полные сбои при чрезмерной нагрузке                                                          |
| **Резервное кэширование**   | Поддержка кэша для ключевых данных, если основной сервис недоступен                                                                                         |
| **Приоритетный доступ**     | Ограничение доступа к критическим функциям для важных пользователей или задач в случае недостатка ресурсов                                                   |

Эти меры помогут обеспечить высокий уровень отказоустойчивости, плавное восстановление системы и минимизацию рисков полного отказа.

<h2 id="10">10 Схема проекта</h2>

![image](/imgs/Ya-diagram.drawio.png)

<h2 id="11">11 Список серверов</h2>

### Веб-сервисы NGINX
На официально сайте [nginx](https://blog.nginx.org/blog/testing-the-performance-of-nginx-and-nginx-plus-web-servers) видно, что сервер с 1 CPU видерживает 4 830 HTTP RPS
![image](https://github.com/user-attachments/assets/dc75a35e-8ef2-49ba-a16f-524a03144d61)

Данные:
* Пиковое значение по RPS для всего трафика: 1000 RPS
* Пиковое значение сетевого трафика: 14.85 Гбит/с
Расчет по RPS: 1 сервер Nginx с 1 CPU поддерживает 4 830 RPS.
Для расчета количества серверов по RPS:
```
1000 RPS / 4 830 RPS = 0.207 серверов
```

Округляем до 1 сервера.
Расчет по сетевому трафику: 1 сервер с 40 Гбит/с может обрабатывать до 40 Гбит/с.
Для сетевого трафика:
```
14.85Гбит/с / 40Гбит/с = 0.371 серверов
```
Округляем до 1 сервера.
Таким образом, для веб-сервера Nginx потребуется 1 сервер (по RPS и сетевому трафику) и получаем следующую конфигурацию для nginx:

Параметр |	Значение
-------- | --------
CPU      |	1
Network  |	40 ГБит/с
Кол-во	 |  1

### Микросервисы

#### RAM
- Зависит от типа задач:
  - Сервисы с высокой нагрузкой на поиск и анализ данных (`Search`, `Recommendation`) требуют больше памяти.
  - Менее загруженные сервисы (`PostOffice`, `Auth`) могут использовать небольшие инстансы.

#### Трафик (МБ/с)
- Рассчитывается по формуле:
  \[
  \text{Трафик (МБ/с)} = \text{RPS} \times \text{Средний размер ответа (в МБ)}
  \]
- Пример для `Product`:  
  \( 390 \, \text{RPS} \times 0.075 \, \text{МБ (средний ответ)} = 30 \, \text{МБ/с} \).

#### Количество серверов
- Определяется из расчета максимальной нагрузки одного инстанса (CPU, RAM).
- Пример для `Search`: если один сервер может обрабатывать 70 RPS, то для 483.8 RPS потребуется 7 серверов.

#### Тип сервера
- **General Purpose** — сбалансированные серверы для задач с умеренной нагрузкой.
- **High Memory** — серверы с большим объемом памяти для интенсивных операций поиска и анализа данных.

| Сервис         | RPS     | RAM (на сервер) | Трафик (МБ/с) | Кол-во серверов | Тип сервера            | Примечания                                          |
|-----------------|---------|-----------------|---------------|------------------|------------------------|---------------------------------------------------|
| **Auth**        | 40      | 4 ГБ            | 1.5           | 2                | General Purpose (4vCPU) | Использование Redis для хранения сессий          |
| **Product**     | 390     | 16 ГБ           | 30            | 5                | High Memory (8vCPU)    | Высокая нагрузка на чтение из БД                  |
| **Order**       | 23.5    | 8 ГБ            | 2             | 2                | General Purpose (4vCPU) | Транзакционная обработка, требует стабильного IOPS |
| **Feedback**    | 96.8    | 8 ГБ            | 4             | 3                | General Purpose (4vCPU) | Сохраняет отзывы в MongoDB                        |
| **PostOffice**  | 10      | 4 ГБ            | 1             | 1                | General Purpose (2vCPU) | Низкая нагрузка                                   |
| **Search**      | 483.8   | 32 ГБ           | 50            | 7                | High Memory (16vCPU)   | Высокая нагрузка на Elasticsearch                 |
| **Recommendation** | 100     | 16 ГБ           | 8             | 3                | High Memory (8vCPU)    | ML-инференс для рекомендаций                     |

### Контейнеры для микросервисов

| Контейнер      | CPU (ядра) | RAM (ГБ) |
|----------------|------------|----------|
| nginx	         | 1          |	2        | 
| Auth           | 2          | 4        |
| Product        | 4          | 8        |
| Order          | 2          | 4        |
| Feedback       | 3          | 6        |
| PostOffice     | 2          | 4        |
| Search         | 6          | 16       |
| Recommendation | 4          | 8        |


### Обоснование распределения ресурсов:

#### Группа 1: **Auth, Order, PostOffice**
- **CPU: 2 ядра**  
  Эти сервисы выполняют относительно простые задачи:
  - Auth — проверка токенов и управление сессиями.  
  - Order — обработка заказов (основные операции с базой).  
  - PostOffice — валидация и геокодинг адресов доставки.  
  Для них достаточно 2 ядер процессора.  
- **RAM: 4 ГБ**  
  Достаточно для временного хранения данных, необходимых для выполнения запросов.

---

#### Группа 2: **Feedback**
- **CPU: 3 ядра**  
  Сервис обрабатывает текстовые отзывы, рейтинги и, возможно, выполняет базовый анализ текста, что требует дополнительных вычислительных мощностей.  
- **RAM: 6 ГБ**  
  RAM используется для кэширования данных отзывов и уменьшения нагрузки на базу.

---

#### Группа 3: **Product, Recommendation**
- **CPU: 4 ядра**  
  - Product — работа с большими объемами данных (фильтрация, получение информации о товарах).  
  - Recommendation — выполнение алгоритмов машинного обучения и генерация персонализированных рекомендаций.  
- **RAM: 8 ГБ**  
  Необходима для работы с кэшем популярных товаров и хранения промежуточных данных моделей рекомендаций.

---

#### Группа 4: **Search**
- **CPU: 6 ядер**  
  Самый ресурсоемкий сервис из-за постоянного взаимодействия с Elasticsearch, выполнения сложных запросов и обработки индексов.  
- **RAM: 16 ГБ**  
  Большой объем памяти нужен для ускорения поиска за счет кэширования индексов и минимизации задержек.



### Базы данных
Для работы с данными нам потребуется настроить несколько баз данных:
* Redis - используется для хранения сессий (in-memory) и хранения кэша для рекомендаций. 6 серверов (1 master + 2 replicas), с учетом 18.2 млн пользователей.
* PostgreSQL - pеляционные таблицы с отношениями. Кластер из 60 серверов: 5 master + 25 slave + реплики, с учетом высокой доступности и транзакционной нагрузки.
* ElasticSeacrh - для полнотекстового поиска по товарам и компаниям. С учетом индексации больших данных потребуется 10 серверов.
* Kafka - для обработки событий. Требуется кластер Kafka, предполагаем ~8 брокеров для обработки событий в реальном времени, реплицируемость обеспечивает надежность.
* MongoDB - для MongoDB потребуется кластер из 3 серверов (1 master + 2 реплики).
* AWS S3 - 200 серверов с дисками объемом 10 ТБ.

----

**Объемы данных для каждой таблицы (учитывая индексы):**

1. PostgreSQL:

- Profile (2.44 ГБ) + индекс по Mail (18.2 млн * 50 байт) ≈ 3.35 ГБ
- Order (5.85 ГБ) + индекс по CreatedAt и Status (130 млн * 50 байт) ≈ 12.35 ГБ
- Product (235.98 ГБ) + индекс по Name (108 млн * 50 байт) ≈ 291.98 ГБ
- Category (1.4 МБ) + индекс по Name ≈ 2 МБ
- Address (3 адреса на пользователя ≈ 54.6 млн * 100 байт) ≈ 5.46 ГБ
- PostOffice (10 тыс записей * 200 байт) ≈ 2 МБ
- OrderProduct (связь заказов и продуктов: 130 млн * 50 байт) ≈ 6.5 ГБ
- ProductCategory (связь продуктов и категорий: 324 млн * 50 байт) ≈ 16.2 ГБ
Итого PostgreSQL: 344.33 ГБ

2. MongoDB:

- MediaFile (10.8 ГБ) + ProductMedia (200 млн связей * 50 байт) ≈ 21.8 ГБ
- FeedBack (112 ГБ) ≈ 112 ГБ
Итого MongoDB: 133.8 ГБ

3. Elasticsearch:

- ProductElasticSearch: ~20% от размера Product для полнотекстового поиска (235.98 ГБ * 0.2) ≈ 47.2 ГБ
- FeedBackElasticSearch: ~20% от размера FeedBack (112 ГБ * 0.2) ≈ 22.4 ГБ
Итого Elasticsearch: 69.6 ГБ

4. Redis:

- Session (28 ГБ) + запас на ключи и метаинформацию (~30%) ≈ 36.4 ГБ
-----
**Память (RAM)**
Для работы с БД и кэшами:

1. PostgreSQL:

Для индексов и кэширования запросов выделяют обычно 10% от общего объема данных.
344.33 ГБ * 0.1 ≈ 34.4 ГБ
2. MongoDB:

Обычно требуется 10–15% от общего объема данных для эффективной работы.
133.8 ГБ * 0.15 ≈ 20 ГБ
3. Elasticsearch:

Рекомендуется выделять 50% RAM для heap (не более 32 ГБ) + память под кэширование.
~32 ГБ для heap + 20 ГБ для кэша ≈ 52 ГБ
4. Redis:

Память равна объему данных + запас на метаданные.
36.4 ГБ ≈ 36.4 ГБ
Итого RAM: 34.4 + 20 + 52 + 36.4 ≈ 143 ГБ

------
**CPU Распределение по RPS и сервисам:**

1. PostgreSQL:

- Высокая нагрузка на чтение (поиск, фильтрация, связи).
- Ожидается ~250 RPS (наиболее активные таблицы).
- Рекомендуется 1 ядро на каждые 50 RPS для интенсивных запросов.
- 5 ядер

2. MongoDB:

- Средняя нагрузка (отзывы, медиафайлы).
- Ожидается ~100 RPS.
- Рекомендуется 1 ядро на каждые 100 RPS.
- 1 ядро

3. Elasticsearch:

- Высокая нагрузка (поиск продуктов, отзывов).
- Ожидается ~484 RPS.
- Рекомендуется 1 ядро на каждые 100 RPS.
- 5 ядер
4. Redis:

- Средняя нагрузка (сессии, авторизация).
- Ожидается ~40 RPS.
- Рекомендуется 1 ядро на каждые 200 RPS.
- 1 ядро
Итого CPU: 12 ядер

----
**Запас и амортизация**
Добавляем запас 20% на амортизацию:
- Хранилище: (344.33 + 133.8 + 69.6 + 36.4) * 1.2 ≈ 695 ГБ
- RAM: 143 * 1.2 ≈ 172 ГБ
- CPU: 12 * 1.2 ≈ 14.4 ядер

База данных   |	Серверы |	CPU (на сервер) |	RAM (на сервер) |	ROM (на сервер)
------------- | ------- | --------------- | --------------- | ---------------
Redis         |	6       |	2               |	32 GB           | 20 GB
PostgreSQL    |	60      |	24              |	512 GB	         | 5 TB
Elasticsearch |	10      |	16              |	64 GB           |	2 TB
Kafka         |	8      |	16              |	64 GB           |	2 TB
MongoDB       |	3       | 16              |	64 GB           |	4 TB
AWS (S3)      | 200     | 64              | 512 GB          | 10 TB

Общее количество серверов: 308.

### Расчет стоимости серверов

#### Исходные данные оборудования

- [**Сервер:**](https://servermall.ru/sets/servery-dell-poweredge-g17/)
  - 2x Intel Xeon 6 6710E (64C, 96M Cache, 2.40 GHz)
  - 2x 32GB DDR5 RDIMM 6400MHz (64GB RAM)
  - 4 порта 10/25GbE
  - 1.9TB NVMe SSD (Read Intensive)
  - Цена: **1 760 109 ₽**

- Один сервер рассчитан на:
  - 64 ядра CPU
  - 64 GB RAM
  - Высокую пропускную способность сети.

#### Потребности сервисов

| Сервис         | RAM (на сервер) | Кол-во серверов | Итоговая RAM   | Пропускная способность (МБ/с) | Кол-во ядер CPU | Примечания                  |
|----------------|-----------------|-----------------|----------------|--------------------------------|-----------------|-----------------------------|
| **Auth**       | 4 ГБ            | 2               | 8 ГБ           | 1.5                          | 8               | Redis для сессий           |
| **Product**    | 16 ГБ           | 5               | 80 ГБ          | 30                           | 40              | Высокая нагрузка            |
| **Order**      | 8 ГБ            | 2               | 16 ГБ          | 2                            | 8               | Транзакционная нагрузка     |
| **Feedback**   | 8 ГБ            | 3               | 24 ГБ          | 4                            | 12              | Хранение отзывов в MongoDB  |
| **PostOffice** | 4 ГБ            | 1               | 4 ГБ           | 1                            | 4               | Низкая нагрузка             |
| **Search**     | 32 ГБ           | 7               | 224 ГБ         | 50                           | 56              | Elasticsearch               |
| **Recommendation** | 16 ГБ         | 3               | 48 ГБ          | 8                            | 24              | ML-инференс                 |

#### Общие ресурсы:

- **Итоговая RAM:** 404 ГБ
- **Итоговая пропускная способность:** ~96 МБ/с
- **Итоговое количество CPU:** 152 ядер

### Расчет серверов для собственного оборудования

#### Серверные характеристики:
- Один сервер предоставляет 64 ядра CPU и 64 ГБ RAM.

#### Расчет количества серверов:
- **RAM:**
  
  \[
  \text{Необходимые серверы} = \lceil \frac{404 \text{ ГБ }}{64 \text{ ГБ }} \rceil = 7 \text{ серверов}
  \]

- **CPU:**

  \[
  \text{Необходимые серверы} = \lceil \frac{152 \text{ ядер }}{64 \text{ ядер }} \rceil = 3 \text{ сервера (ограничение CPU)}
  \]

Итого требуется **7 серверов** для RAM.

#### Общая стоимость:
- Цена одного сервера: 1 760 109 ₽
- Количество серверов: 7
- **Итоговая стоимость:**
  \[
  1 760 109 \times 7 = 12 320 763 \text{ ₽}
  \]

#### Расчет стоимости аренды в AWS

AWS предоставляет несколько решений для аренды серверов:

1. **m6i.4xlarge** (16 vCPU, 64 ГБ RAM):
   - Цена за on-demand: $0.922/час.
   - Необходимое количество инстансов: 7.

   \[
   \text{Стоимость в месяц} = 7 \times 0.922 \times 24 \times 30 = 4 648 \text{ $}
   \]

   В рублях:
   \[
   4 648 \times 96 = 446 208 \text{ ₽ в месяц}
   \]

2. **c6i.2xlarge** (8 vCPU, 16 ГБ RAM):
   - Цена за on-demand: $0.34/час.
   - Для 404 ГБ потребуется:

   \[
   \text{Серверы} = \lceil \frac{404}{16} \rceil = 26 \text{ серверов}
   \]

   Стоимость в месяц:
   \[
   26 \times 0.34 \times 24 \times 30 = 6 362 \text{ $}
   \]

   В рублях:
   \[
   6 362 \times 96 = 610 752 \text{ ₽ в месяц}
   \]

#### Итоги аренды:
- **On-demand (m6i.4xlarge):** ~446 208 ₽/мес.
- **On-demand (c6i.2xlarge):** ~610 752 ₽/мес.
- **Годовая стоимость:**
  - **m6i.4xlarge:** ~5 354 496 ₽
  - **c6i.2xlarge:** ~7 329 024 ₽

#### Сравнение собственных серверов и аренды

| Параметр                   | Собственные сервера      | Аренда AWS (m6i.4xlarge) | Аренда AWS (c6i.2xlarge) |
|----------------------------|--------------------------|--------------------------|--------------------------|
| **Стоимость (годовая)**   | ~12 320 763 ₽           | ~5 354 496 ₽            | ~7 329 024 ₽            |
| **Первоначальные вложения** | Да                      | Нет                      | Нет                      |
| **Гибкость**              | Ограниченная             | Высокая                  | Высокая                  |
| **Поддержка**             | Требуется самостоятельно | AWS                      | AWS                      |

#### Выводы
- При долгосрочной эксплуатация (>3 лет) собственные сервера окупятся.
- Для краткосрочного проекта или тестов лучше использовать AWS.


