# Расчетно-пояснительная записка

<h3 id="Content">Содержание</h3>

#### 1. [Тема и целевая аудитория](#1)
#### 2. [Расчет нагрузки](#2)
#### 3. [Глобальная балансировка нагрузки](#3)
#### 4. [Локальная балансировка нагрузки](#4)
#### 5. [Логическая схема базы данных](#5)
#### 6. [Физическая схема базы данных](#6)
#### 7. [Алгоритмы](#7)

<h2 id="1">1 Тема и целевая аудитория</h2>

В качестве типа сервиса для проектирования я выбрал маркетплейс **Яндекс Маркет**. Данный сервис отвечает требованиям к теме:

- **Имеет реальные аналоги**, доказывающие существование рыночной ниши — Ozon, Wildberries, Купер.
- **Аудитория сервиса** свыше 1 миллиона активных пользователей по данным [inclient.ru](https://inclient.ru/yandex-stats).
  
  | Яндекс Маркет           | Количество  |
  |-------------------------|-------------|
  | **Активные покупатели** | 18.2 млн    |
  | **Активные продавцы**   | 80.6 тысяч  |

- Наибольшим спросом **Яндекс Маркет** пользуется в России (94.48% интернет-трафика), Беларуси (0.97%), Узбекистане (0.74%) и Казахстане (0.73%).
- **Имеет сложную, нетривиальную архитектуру**.

## Функционал

Ключевой функционал для данного сервиса:

1. **Поиск и фильтрация товаров**
   - Система поиска использует **алгоритмы машинного обучения** для более точного подбора результатов на основе предпочтений пользователя. Это также включает умные фильтры, которые позволяют пользователям быстро находить подходящие товары.

2. **Система отзывов и рейтингов**
   - Интегрированная система отзывов с **верификацией подлинности** (например, отзывы только от пользователей, которые действительно купили товар) и **фильтры для сортировки отзывов** по полезности, дате или оценке.
  
3. **Рекомендации товаров в ленте**
   - **Рекомендации товаров в ленте** на основе пользовательских просмотров и ранее совершенных покупок. Это позволяет персонализиовать ленту товаров для пользователя и его удобства.

4. **Оформление заказа**
   - Возможность выбора из нескольких вариантов доставки (курьером, в пункт выдачи, постамат) и множества способов оплаты (банковские карты, электронные кошельки, наложенный платеж). Платформа также позволяет пользователям сохранять несколько адресов доставки.

5. **Сравнение товаров**
   - **Сравнение товаров** с выделением ключевых характеристик и различий, что помогает пользователям принять обоснованное решение.

6. **Управление учетной записью и заказами**
   - **Личный кабинет** с возможностью настройки профиля, просмотра истории покупок и отслеживания текущих заказов.

## Сокращение до MVP

Для создания MVP (минимально жизнеспособного продукта) Яндекс Маркета можно урезать функционал до следующих ключевых функций:

1. **Поиск и фильтрация товаров** (с базовыми фильтрами).
2. **Система отзывов и рейтингов** (с текстовыми отзывами и оценками).
3. **Рекомендации товаров в ленте**.
4. **Оформление заказа** (с одним способом доставки и оплаты).
5. **Сравнение товаров** (базовое сравнение двух товаров по ключевым характеристикам).
6. **Управление учетной записью и заказами** (с основными функциями).

<h2 id="2">2 Расчет нагрузки</h2>

### Продуктовык метрики
- **MAU** - 30,66 млн (https://dzen.ru/a/ZkT8wKCKkBgtJMT-)
- **DAU** - 8,76 млн

Данные о товаре на Яндекс Маркете необходимые для его публикации (https://yandex.ru/support2/marketplace/ru/assortment/fields/)
  | Данные           | Размер (предполагаемый)  |
  |---------|-------------|
  | **SKU** | 0.51 КБ    |
  | **Название**   | 0.51 КБ |
  | **Изображения**   | 30*10 МБ  |
  | **Базовая цена**   | 0.0039 КБ |
  | **Фото 360**   | 72*10 МБ  |
  | **Видео**   | 3*60 МБ  |
  | **Описание**   | 12 КБ  |
  | **Категория товара**   | 0.2 КБ  |
  | **...**   | ...  |
  
Размеры в мегабайтах:
0.00051 + 0.00051 + 300 + 720 + 180 + 0.012 + 0.0002 = 1200.02321 МБ.

Округлим до 1200 МБ, потому как так еще остались возможные характеристики товаров, но по сравнению с размерами медиа-файлов их размел мал.
Таким образом, предполагаемый общий объем данных составляет около 1200 МБ, или 1.2 ГБ.*

>*Яндекс не храниит большие размеры медиа-файлов, а сжимает до нескольких копий для разного размера экрана:
>
> **Изображения:**
> | Размер изображения | Память                |
> |--------------------|-----------------------|
> | 190×250            | 0.14 МБ               |
> | 240×320            | 0.23 МБ               |
> | 300×400            | 0.36 МБ               |
> | 351×468            | 0.49 МБ               |
> | 402×536            | 0.65 МБ               |
> | 450×600            | 0.81 МБ               |
> | 501×668            | 1.00 МБ               |
> | 552×736            | 1.22 МБ               |
> | 600×800            | 1.44 МБ               |
> | **Всего сумма**    | **6.34 МБ**           |
>
>  **Видео:**
> | Тип данных         | Разрешение  | Память                |
> |--------------------|-------------|-----------------------|
> | Прелоад изображения | 600×800     | 1.44 МБ               |
> | Первоначальный кадр видео | 1080×1920 | 6.22 МБ               |
> | Стриминг видео (прогрессивный) | Зависит от сегментации и сети | Переменная (зависит от продолжительности и качества) |
> | **Всего (без учёта стрима)**  |             | **7.66 МБ + стрим**  |
>
> Таким образом размеры стоит пересчитать, взяв что в среднем на товар приходится 10 фотографий и 1 видео, а не 30 и 3 соответсвенно: 
> 0.00051 + 0.00051 + 10*6.4 + 24*6,4 + 60 + 0.012 + 0.0002 = 278 МБ.
>
> Это кажется не слишком сильно сократило размер хранения, но это сильно уменьшило размеры подгружаемых файлов файлов, потому загружается только фотография нужного формата для ленты, а видео там нет вообще. Возьмем среднее значение для изображений для ленты 402х556 - **0,65 МБ**


Основные действия по функционалу MVP:

  | Действие | Кол-во в день на одного пользователя в среднем  |
  |---------|-------------|
  | **Поиск и фильтрация товаров** | 4 |
  | **Система отзывов и рейтингов**   | 0.03 (1 в месяц) |
  | **Оформление заказа**   | 0.14 ( 1 в неделю )   |
  | **Сравнение товаров**   | 1 |
  | **Управление учетной записью и заказами**   | 0.14 ( 1 в неделю )  |
  
### Технические метрики

- **Хранилище**:  
  Количество товаров на Яндекс Маркете — **108 млн** ([Источник](https://yastatic.net/s3/ir-docs/docs/2024/q2/57a1cu049ffbd144aeged36d47h173c2/MKPAO_Press_Release_RUS_rs94k.pdf)).

  Посчитав до этого, сколько примерно нужно для хранения одного товара, получаем **3.1 петабайта** памяти.

- **Сетевой трафик**  
  Расчитаем трафик для активностей, выбранных в MVP:

  - **Поиск товаров (лента)**:  
    4 запроса/день, при которых загружаются 20 товаров с одной фотографией среднего размера (который мы выбрали до этого — **0.65 МБ**), названием (**0.51 КБ**) и ценой (**0.0039 КБ**).  
    Рассчитаем:  
    `4 * 20 * (665 + 0.51 + 0.0039) КБ = 52 МБ`

  - **Оставление отзыва**:  
    0.03 запроса/день. Средний размер отзыва — 3 текстовых поля по 200 символов и 3 фотографии 600×800, что в сумме составляет **4.32 МБ**.  
    Рассчитаем:  
    `0.03 * 4.32 МБ = 0.144 МБ`

  - **Оформление заказа**:  
    0.14 запроса/день. В среднем заказ включает 3–4 товара, возьмем 4. Размер одного товара:  
    `0.00051 КБ + 0.00051 КБ + 6.4 МБ + 0.012 КБ + 0.0002 КБ = 6.5 МБ`,  
    так как при загрузке не отображаются видео и Фото 360, а показывается 1 фотография.  
    Рассчитаем:  
    `0.14 * 4 * 6.5 МБ = 3.64 МБ`

  - **Сравнение товаров**:  
    1 запрос/день. Возьмем те же условия, что и в прошлом пункте, но товары для сравнения загружаются в количестве 2–3.  
    Рассчитаем:  
    `1 * 3 * 6.5 МБ = 19.5 МБ`

  **Итого сетевой трафик на одного пользователя в день**:  
  `52 + 0.144 + 3.64 + 19.5 = 72.2 МБ`
- **Сетевой трафик по видам активности (дневная аудитория 8.76 млн. пользователей):**

  Пиковое значение активности пользователей(соответственно RPS тоже) приблизительно в 1.66 раза выше среднего значения. Возьмем коэффициент запаса равный 2
  
  Тип                           | Отправка (дневная аудитория 8.76 млн) | Отправка Гб/сек | Пиковое значение | Значение с коэффициентом запаса 2 |
  -------------                 | ------------------------------------  |---------------- |----------------- |---------------------------------- |
  Поиск товаров                 | 8.76 млн * 52 МБ = 434 ТБ             | 5.14            | 8.53             | 10.28                            |
  Оставление отзывов            | 8.76 млн * 0.144 МБ = 1.2 ТБ          | 0.014           | 0.023            | 0.028                              |
  Оформление заказа             | 8.76 млн * 3.64 МБ = 30 ТБ            | 0.35            | 0.581            | 0.7                              |
  Сравнение товаров             | 8.76 млн * 19.5 МБ = 162 ТБ           | 1.92            | 3.19             | 3.84                             |
  Итого                         | 627,2 ТБ	                            | 7.424           | 12.32            | 14.85                              |
- **RPS**
 
  * Поиск товаров: 8.76 млн * 4 / 86400 = 387 RPS
  * Добавление товаров в корзину: 8.76 млн * 0.03 / 86400 = 2.9 RPS
  * Оформление заказов: 8.76 млн. * 0.14 / 86400 = 13.5 RPS
  * Оставление отзывов: 8.76 млн. * 1 / 86400 = 96.8 RPS
  
  Действие                            | RPS  | Пиковое значение | Пиковое значение с коэффициентом запаса 2  |
  ------------------------------------| ---  |----------------- |------------------------------------------- |
  Поиск товаров                       | 387  | 642              | 774                                        |
  Добавление товаров в корзину        | 2.9  | 4.8              | 5.8                                        |
  Оформление заказов                  | 13.5 | 22.4             | 27                                         |
  Оставление отзывов                  | 96.8 | 160.7            | 193.6                                      |
  **Итого**                           | 500.2| 830              | 1000                                       | 

<h2 id="3">3 Глобальная балансировка нагрузки</h2>

### География пользователей

Целевая аудитория Яндекс Маркета распределена по странам СНГ, с преобладанием в России. Вот как распределяются пользователи по регионам:

Страна       | Процентное соотношение
-------------| ----------------------
Россия       | 84.8%
Азербайджан     | 3.1% 
Китай    | 1.4%
Казахстан       | 1.2% 

Это определяет необходимость расположения датацентров (ДЦ) преимущественно в России и других странах СНГ для обеспечения низкой задержки и высокой производительности.

### Функциональное разбиение по доменам

Для оптимизации работы и распределения нагрузки по различным функциональным модулям можно применить функциональное разбиение по доменам. Это позволяет отдельным частям системы работать независимо друг от друга, улучшая масштабируемость и отказоустойчивость.

Примеры функциональных доменов:

* market.yandex.ru — API-сервисы для мобильных приложений и веб-версии.
* mc.yandex.ru — доставка медиа-контента (фото товаров, видео, баннеры).

Такое разбиение позволяет улучшить управляемость трафика, распределять нагрузку на отдельные системы, а также внедрять более гибкие методы балансировки.

### Обоснование расположения ДЦ

На основе (https://telegra.ph/Gde-data-centry-YAndeksa-03-07), [склады](https://yandex.ru/maps/?from=mapframe&ll=52.821695%2C53.073344&mode=usermaps&source=mapframe&um=constructor%3Acbecbebc1953af83c4a0453d8ace4feb7dc239f35d3278858320e5e86909535d&utm_source=mapframe&z=5.86) и [ПВЗ](https://yandex.ru/maps/?ll=91.148707%2C60.336308&mode=search&sctx=ZAAAAAgBEAAaKAoSCZ5eKcsQz0JAEdOgaB7A4EtAEhIJA137Anqh8j8RmPxP%2Fu4d7D8iBgABAgMEBSgKOABA4QFIAWoCcnWdAc3MzD2gAQCoAQC9AUi2ORzCAZIBieaipIME2ezzwqcBr6TszPMDitXvyckD7LrwnZ4G7deH0pUD9cnavIIH9ru3oo4Dzv6nl58F7%2FSv2OsD686Zr%2B0CiZX99mOP8OCVsAWpo9PI3AbI%2Bd%2B6oALm0OywvgbN7P2ZqwWWkZnrVsyR1KM%2Fivnh2NgCyvae27UGscn6yKQBsfvy4fYEmLeSkzf6uu7YmQOCAkPQv9GD0L3QutGC0Ysg0LLRi9C00LDRh9C4INGP0L3QtNC10LrRgSDQvNCw0YDQutC10YIg0L3QsCDQutCw0YDRgtC1igIAkgIAmgIMZGVza3RvcC1tYXBzqgIZMTM5NzIyMjgxMTE5LDIzNzkyMzg3NjQ5NrACAQ%3D%3D&sll=91.148707%2C60.336308&sspn=124.433297%2C36.312187&text=пункты%20выдачи%20яндекс%20маркет%20на%20карте&z=4.22) можно обосновать расположение датацентров. Основная цель — снизить сетевые задержки и улучшить производительность для конечных пользователей.

Страна    | Локация ДЦ                | Обоснование
----------| --------------------------| ---------------------------------------------------------------------------
Россия    |	Москва и подмосковье	  | 95.7% пользователей из России, оптимизация для западной части страны и Европы
Россия   |	       Санкт-Петербург          | Поддержка пользователей из Северной части Росии
Россия    |	Калуга	 | Поддержка основных пользователей западной части России и Европы
Россия    |	Новосибирск	 | Покрытие для пользователей Центральной России, Урала, Сибири
Россия  |	Владимирская область | Поддержка основных пользователей западной части России и Европы


Основное внимание уделяется России, так как большинство пользователей находится в этой стране. Однако наличие датацентров в соседних странах (Казахстан) помогает улучшить доступ к сервису и уменьшить задержки для пользователей этих регионов.

### Расчет распределения запросов по типам

На основе данных о нагрузке и географии пользователей можно рассчитать распределение запросов по типам для каждого датацентра.

Тип запроса                  |	RPS (Запад России) |	RPS (Центр России) |	RPS (Север)	| 
-----------------------------| -------------------| -------------------|---------------|
Поиск товаров                |	580.4             |	116.1                          |	30.96
Добавление товаров в корзину |	4.35            |	0.86                          | 0.232 
Оформление заказов           |	10.12             |	2.02                           |	0.5  
Оставление отзывов           |	72.6             |	14.52                          |	2.9  
Итого                        |	667.51           |	133.87                       |	34.6   

Общая нагрузка распределена пропорционально процентному соотношению пользователей в каждом регионе. Запад России несет наибольшую нагрузку, следом идут центральные регионы России.

### Схема DNS-балансировки

DNS-балансировка позволяет распределять трафик на уровне DNS-запросов, направляя пользователей к наиболее подходящему датацентру в зависимости от их географического местоположения.

Пример работы DNS-балансировки:
1. Пользователь из России отправляет запрос на market.yandex.ru.
2. DNS-сервер будет направлять пользователей на ближайший ДЦ с учетом их географического расположения. Для пользователей в центральной России и Сибири трафик будет перенаправляться в Новосибирск, а пользователи из западной части России будут обслуживаться в Москве и подмосковье.

### Схема Anycast-балансировки

Anycast-балансировка позволяет направлять запросы к ближайшему датацентру с минимальной задержкой. Использование Anycast помогает автоматически балансировать нагрузку на основе топологии сети и состояния датацентров.

Пример Anycast-балансировки:
1. Пользователь отправляет запрос на market.yandex.ru.
2. Протокол Anycast направляет запрос в ближайший CDN-сервер (например, в Москве, если пользователь из России).
3. Если датацентр перегружен или недоступен, Anycast перенаправляет запрос к следующему ближайшему датацентру, например, в Китай.

### Механизм регулировки трафика между ДЦ

Для динамической балансировки нагрузки между датацентрами можно использовать такие механизмы, как:
1. Routing — направляет пользователей в ближайший датацентр на основе географической локации. Данный способ будет предпочтительней чем GeoDNS, так как в основном вся аудитория находится внутри однойстраны - России.
2. Мониторинг нагрузки — автоматическая оценка текущей загрузки ДЦ и переключение на менее загруженные датацентры в случае перегрузки.
3. Технология GSLB (Global Server Load Balancing) — глобальное распределение запросов между датацентрами с учетом нагрузки, доступности и производительности каждого ДЦ.


<h2 id="4">4 Локальная балансировка нагрузки</h2>

### Схемы балансировки

Для надежности системы балансировки будет применена многоуровневая архитектура с несколькими уровнями балансировщиков.

Пример схемы:

![image](/imgs/scheme.png)

### 1. Входной уровень

Мы будем использовать 2 (лучше 3) пары балансировщика **NGINX** для обеспечения отказоустойчивости. Через этот уровень проходят все внешние запросы к приложению, и на этом уровне будет выполняться терминация SSL и начальное распределение нагрузки между внутренними балансировщиками.

**Задачи:**
- Терминация SSL.
- Начальное распределение нагрузки между внутренними балансировщиками.

**Алгоритмы распределения:**
- **Round Robin** или **Least Connections** для равномерного распределения входящих запросов между внутренними балансировщиками.

### 2. Внутренний уровень балансировки

Будем использовать 2 (лучше 3) пары **Istio** для распределения запросов между микросервисами. Этот уровень предназначен для внутренней балансировки межсервисных запросов, когда одна служба обращается к другой.

**Задачи:**
- Управление трафиком между микросервисами.
- Учет нагрузки и состояний сервисов для динамического распределения.

**Алгоритмы распределения:**
- **Dynamic Load Balancing** или **Weighted Round Robin** для учета производительности и состояния микросервисов.

### Связь между балансировщиками

1. **Входной уровень → Внутренний уровень**:
   - Балансировщики на входном уровне (NGINX) после терминации SSL перенаправляют зашифрованные запросы на внутренние балансировщики (Istio) для дальнейшего распределения по микросервисам.
   - Для передачи запросов может использоваться **L4** (для транспортного уровня) или **L7** (для анализа содержимого HTTP-запросов). Например, если нужно маршрутизировать запросы по URL, предпочтительнее использовать **L7**.

2. **Взаимодействие между внутренними балансировщиками**:
   - Внутренние балансировщики (Istio) взаимодействуют между собой через Service Mesh, что позволяет обеспечивать согласованность и гибкость распределения межсервисного трафика.
   - Они могут использовать алгоритмы динамического распределения трафика, а также гибкие правила маршрутизации запросов в зависимости от нагрузки и текущего состояния сервисов.

3. **Отказоустойчивость между уровнями**:
   - В случае отказа одного из балансировщиков на входном уровне, другие автоматически возьмут на себя нагрузку. Это обеспечивается через механизмы **Failover** и использование **виртуальных IP-адресов**.
   - На внутреннем уровне балансировщики также работают в схеме отказоустойчивости, где Service Mesh (Istio) может динамически перенаправлять запросы на активные микросервисы или балансировщики.

### Входящие запросы

- **Round Robin**: Запросы равномерно распределяются между всеми доступными серверами.
- **Least Connections**: Запросы направляются на сервер с наименьшим количеством активных подключений.
- **IP Hash**: Выбор сервера на основе хеша IP-адреса клиента, что сохраняет привязку пользователя к одному серверу.
- **Weighted Round Robin**: Серверы получают запросы в зависимости от их веса (полезно для серверов с различными характеристиками).

### Межсервисные запросы

- **Service Mesh** (например, Istio или Linkerd): Для управления трафиком между микросервисами.
- **Consistent Hashing**: Подходит для распределенных систем, где необходимо сохранить консистентность при добавлении или удалении серверов.
- **Dynamic Load Balancing**: Агенты мониторинга состояния сервисов для динамического распределения нагрузки.

### Схема отказоустойчивости

- **Горизонтальное масштабирование**: Несколько экземпляров серверов для устранения влияния отказа одного сервера.
- **Health Checks**: Регулярные проверки состояния серверов, чтобы трафик не направлялся на неработающие узлы.
- **Failover**: Перенаправление трафика на резервные серверы в случае отказа основного.
- **Виртуальные IP-адреса**: Использование Keepalived или аналогов для настройки отказоустойчивых VIP (Virtual IP) для балансировщиков.

### Расчет нагрузки по терминации SSL

- **Терминация SSL на балансировщике нагрузки**: Снятие нагрузки на дешифровку трафика с backend-серверов.
- **Показатели нагрузки**:
  - Оценка количества операций терминации SSL в секунду при максимальной нагрузке (например, используя `ssl_handshake_time` для NGINX).
  - **Аппаратное ускорение**: Используйте SSL-ускорители для снижения нагрузки на процессоры.
  - **Ресурсные затраты**: Определение количества ресурсов (CPU, память), затрачиваемых на поддержку сессий SSL, для правильного планирования мощности балансировщиков.

### Технологии

- **Балансировка нагрузки**: NGINX.
- **Межсервисное взаимодействие**: Kubernetes.


<h2 id="5">5 Логическая схема БД</h2>

Схема БД:
![image](/imgs/ya-market-logic.png)

### Описание таблиц базы данных

| **Таблица**          | **Поле**           | **Тип данных**      | **Описание**                                                  | **Размер данных (в байтах)** |
|----------------------|--------------------|---------------------|---------------------------------------------------------------|-----------------------------|
| **Profile**          | ProfileId          | integer, pk         | Уникальный идентификатор профиля (автоинкремент).              | 4                           |
|                      | Mail               | varchar(50)         | Электронная почта пользователя.                               | 50                          |
|                      | Name               | varchar(20)         | Имя пользователя.                                             | 20                          |
|                      | Password           | varchar(60)         | Хешированный пароль пользователя.                             | 60                          |
| **Итого**            |                    |                     |                                                               | **134 байта**               |
| **Address**          | AddressId          | integer, pk         | Уникальный идентификатор адреса (автоинкремент).               | 4                           |
|                      | location           | varchar(200)        | Адрес доставки.                                               | 200                         |
|                      | ProfileId          | integer, fk         | Связь с таблицей Profile через ProfileId.                     | 4                           |
| **Итого**            |                    |                     |                                                               | **208 байт**                |
| **Order**            | OrderId            | integer, pk         | Уникальный идентификатор заказа (автоинкремент).               | 4                           |
|                      | CreatedAt          | timestamp           | Время создания заказа.                                        | 8                           |
|                      | AddressId          | integer, fk         | Связь с таблицей Address через AddressId.                     | 4                           |
|                      | PaidAt             | timestamp           | Время оплаты заказа.                                          | 8                           |
|                      | Status             | varchar(20)         | Статус заказа.                                                | 20                          |
|                      | Delivery           | boolean             | Указывает, требуется ли доставка.                             | 1                           |
| **Итого**            |                    |                     |                                                               | **45 байт**                 |
| **Product**          | SKU                | integer, pk         | Уникальный идентификатор продукта (автоинкремент).             | 4                           |
|                      | Name               | varchar(100)        | Название продукта.                                            | 100                         |
|                      | Price              | integer             | Цена продукта.                                                | 4                           |
|                      | Description        | varchar(2000)       | Описание продукта.                                            | 2000                        |
|                      | Sizes              | varchar(40)         | Размеры продукта.                                             | 40                          |
|                      | Weight             | varchar(10)         | Вес продукта.                                                 | 10                          |
|                      | WarrantyDays       | date                | Срок гарантии продукта.                                       | 3                           |
|                      | Color              | varchar(20)         | Цвет продукта.                                                | 20                          |
|                      | OrderId            | integer, fk         | Связь с таблицей Order через OrderId.                         | 4                           |
|                      | Rate               | float               | Рейтинг продукта                                              | 8                           |
| **Итого**            |                    |                     |                                                               | **2185 байт**               |
| **ProfileProduct**         | ProfileId         | integer, pk fk        | Связь с таблицей Profile через ProfileId.            | 4                           |
|                      | ProductId         | integer, pk fk        | Связь с таблицей Product через ProducteId.            | 4                           |
| **Итого**            |                    |                     |                                                               | **8 байт**                 |
| **Category**         | CategoryId         | integer, pk         | Уникальный идентификатор категории (автоинкремент).            | 4                           |
|                      | Name               | varchar(20)         | Название категории.                                           | 20                          |
|                      | ParentId           | integer, fk         | Связь с таблицей Category через CategoryId (для подкатегорий). | 4                           |
| **Итого**            |                    |                     |                                                               | **28 байт**                 |
| **MediaFile**        | MediaFileId        | integer, pk         | Уникальный идентификатор медиафайла (автоинкремент).           | 4                           |
|                      | Type               | varchar(10)         | Тип медиафайла (например, изображение, видео).                | 10                          |
|                      | RelativeUrl        | varchar(40)         | URL для доступа к файлу.                                      | 40                          |
| **Итого**            |                    |                     |                                                               | **54 байта**                |
| **PostOffice**       | PostOfficeId       | integer, pk         | Уникальный идентификатор почтового отделения (автоинкремент).  | 4                           |
|                      | location           | varchar(200)        | Адрес почтового отделения.                                    | 200                         |
|                      | WorkTime           | varchar(200)        | Время работы почтового отделения.                             | 200                         |
| **Итого**            |                    |                     |                                                               | **404 байта**               |
| **FeedBack**         | FeedBackId         | integer, pk         | Уникальный идентификатор отзыва (автоинкремент).               | 4                           |
|                      | ProductId          | integer, fk         | Связь с таблицей Product через SKU.                           | 4                           |
|                      | ProfileId          | integer, fk         | Связь с таблицей Profile через ProfileId.                     | 4                           |
|                      | CreatedAt          | timestamp           | Время создания отзыва.                                        | 8                           |
|                      | Payload            | varchar(200)        | Текст отзыва.                                                 | 200                         |
|                      | Rate               | integer             | Оценка продукта (1-5).                                        | 4                           |
| **Итого**            |                    |                     |                                                               | **224 байта**               |
| **Session**	|SessionId |	integer, pk | 	Уникальный идентификатор сессии (автоинкремент). |	4 |
| | ProfileId |	integer, fk |	Связь с таблицей Profile через ProfileId.	| 4 |
| | CreatedAt |	timestamp |	Время создания сессии. |	8 |
| | ExpiresAt | 	timestamp	 | Время истечения сессии. | 	8  |
| | Token | 	varchar(255) | 	Уникальный токен для идентификации сессии. |	255 |
| |  IsActive | 	boolean	| Указывает, активна ли сессия. | 	1  |
| **Итого** |                    |                     |                                                               |			**280 байт** |

#### Общий расчет объема хранения для таблиц Яндекс Маркета

Исходные данные:

- **Количество пользователей (Profile)**: 18.2 млн
- **Количество товаров (Product)**: 108 млн
- **Количество заказов (Order)**: 130 млн
- **Количество категорий (Category)**: 50 тыс
- **Количество медиафайлов (MediaFile)**: 200 млн
- **Количество отзывов (FeedBack)**: 500 млн
- **Количество сессий (Session)**: 100 млн
- **Количество адресов (Address)**: предположим, 3 адресса на пользователя = 54,6 млн
- **Количество связей продукт-категория (ProductCategory)**: предположим, 3 категории на продукт = 324 млн

#### Profile
- **Количество записей**: 18.2 млн
- **Размер одной записи**: 134 байта

Общий размер таблицы Profile = 18.2 млн * 134 байт = 2,438,800,000 байт ≈ 2.44 ГБ

#### Profile
- **Количество записей**: 18.2 млн
- **Размер одной записи**: 134 байта

Общий размер таблицы Profile = 18.2 млн * 134 байт = 2,438,800,000 байт ≈ 2.44 ГБ

#### Order
- **Количество записей**: 130 млн
- **Размер одной записи**: 45 байт

Общий размер таблицы Order = 130 млн * 45 байт = 5,850,000,000 байт ≈ 5.85 ГБ


#### Product
- **Количество записей**: 108 млн
- **Размер одной записи**: 2185 байт

Общий размер таблицы Product = 108 млн * 2185 байт = 235,980,000,000 байт ≈ 235.98 ГБ


#### Category
- **Количество записей**: 50 тыс
- **Размер одной записи**: 28 байт

Общий размер таблицы Category = 50 тыс * 28 байт = 1,400,000 байт ≈ 1.4 МБ

#### MediaFile
- **Количество записей**: 200 млн
- **Размер одной записи**: 54 байта

Общий размер таблицы MediaFile = 200 млн * 54 байт = 10,800,000,000 байт ≈ 10.8 ГБ

#### FeedBack
- **Количество записей**: 500 млн
- **Размер одной записи**: 224 байта

Общий размер таблицы FeedBack = 500 млн * 224 байт = 112,000,000,000 байт ≈ 112 ГБ

#### Session
- **Количество записей**: 100 млн
- **Размер одной записи**: 280 байт

Общий размер таблицы Session = 100 млн * 280 байт = 28,000,000,000 байт ≈ 28 ГБ


### Требования к консистентности
В зависимости от типов данных и природы приложения, можно выделить следующие требования к консистентности:

- Сессии (Session): требуется строгая консистентность, так как данные о сессиях пользователей используются для аутентификации и управления доступом. Важно, чтобы сессия создавалась, обновлялась или завершалась в реальном времени, без задержек.
- Заказы (Order): требуется строгая консистентность для подтверждения и оплаты заказов. Примером могут быть транзакции для изменения статусов заказа (оплачен/не оплачен) с проверкой целостности данных.
- Отзывы (FeedBack): консистентность важна, но допустимо использование eventual consistency, когда данные о новых отзывах могут быть слегка отложены, например, при использовании асинхронных операций для хранения отзывов и изображений.
- Продукты и Категории: данные о продуктах и категориях должны быть консистентными при добавлении, удалении или изменении, чтобы обеспечить корректную классификацию товаров.
### Особенности распределения нагрузки по ключам
Для эффективного распределения нагрузки и использования ключей важно:

- Profile/ProfileId: равномерное распределение ключей на уровне профилей, чтобы избежать перегрузки одного сегмента. Шардирование может основываться на диапазонах ProfileId.
- Order/OrderId: важно сбалансированное распределение ключей по времени создания заказа, что особенно актуально для высоконагруженных систем. Здесь можно использовать подходы time-based шардирования для улучшения распределения.
- Product/SKU: шардирование по идентификаторам товаров должно учитывать возможность частых запросов к популярным товарам, чтобы избегать перегрузки одного шарда.
- Session/SessionId: сессии можно шардировать по SessionId или по времени создания, чтобы равномерно распределить активные сессии между различными серверами, особенно при высоком количестве одновременных пользователей
### Размеры данных и нагрузка на чтение/запись
Для оценки нагрузки на чтение и запись, необходимо учитывать следующие моменты:

- Profile: загрузка профилей будет регулярной, однако обновление будет редким, что снижает нагрузку на запись.
- Order: система должна быть оптимизирована на частую запись и чтение, поскольку создание и обновление заказов происходит часто.
- Product: информация о продуктах чаще всего читается, чем обновляется, поэтому можно использовать кэширование.
- FeedBack: данные отзывов тоже можно кэшировать, так как это в основном запросы на чтение.
- Session: данные сессий требуют быстрого чтения и записи для поддержки текущих сессий пользователей. Однако данные сессий могут устаревать, поэтому можно внедрить механизм автоматической очистки старых или неактивных сессий для экономии ресурсов.

<h2 id="6">6 Физическая схема БД </h2>

Схема БД:

![image](/imgs/ya-market.png)

### Описание таблиц базы данных

| **Таблица**          | **Поле**           | **Тип данных**      | **Описание**                                                  | **Размер данных (в байтах)** |
|----------------------|--------------------|---------------------|---------------------------------------------------------------|-----------------------------|
| **Profile**          | ProfileId          | integer, pk         | Уникальный идентификатор профиля (автоинкремент).              | 4                           |
|                      | Mail               | varchar(50)         | Электронная почта пользователя.                               | 50                          |
|                      | Name               | varchar(20)         | Имя пользователя.                                             | 20                          |
|                      | Password           | varchar(60)         | Хешированный пароль пользователя.                             | 60                          |
| **Итого**            |                    |                     |                                                               | **134 байта**               |
| **Address**          | AddressId          | integer, pk         | Уникальный идентификатор адреса (автоинкремент).               | 4                           |
|                      | location           | varchar(200)        | Адрес доставки.                                               | 200                         |
|                      | ProfileId          | integer, fk         | Связь с таблицей Profile через ProfileId.                     | 4                           |
| **Итого**            |                    |                     |                                                               | **208 байт**                |
| **Order**            | OrderId            | integer, pk         | Уникальный идентификатор заказа (автоинкремент).               | 4                           |
|                      | CreatedAt          | timestamp           | Время создания заказа.                                        | 8                           |
|                      | AddressId          | integer, fk         | Связь с таблицей Address через AddressId.                     | 4                           |
|                      | PaidAt             | timestamp           | Время оплаты заказа.                                          | 8                           |
|                      | Status             | varchar(20)         | Статус заказа.                                                | 20                          |
|                      | Delivery           | boolean             | Указывает, требуется ли доставка.                             | 1                           |
|                      | OrderPrice           | integer             | Цена доставки.                             | 4                           |
|                      | PostOfficeId       | integer, fk         | Связь с таблицей PostOffice через PostOfficeId.               | 4                           |
| **Итого**            |                    |                     |                                                               | **53 байт**                 |
| **Product**          | SKU                | integer, pk         | Уникальный идентификатор продукта (автоинкремент).             | 4                           |
|                      | Name               | varchar(100)        | Название продукта.                                            | 100                         |
|                      | Price              | integer             | Цена продукта.                                                | 4                           |
|                      | Description        | varchar(2000)       | Описание продукта.                                            | 2000                        |
|                      | Sizes              | varchar(40)         | Размеры продукта.                                             | 40                          |
|                      | Weight             | varchar(10)         | Вес продукта.                                                 | 10                          |
|                      | WarrantyDays       | date                | Срок гарантии продукта.                                       | 3                           |
|                      | Color              | varchar(20)         | Цвет продукта.                                                | 20                          |
|                      | Rate               | float               | Рейтинг продукта                                              | 8                           |
|                      | Categories         | [] varchar(20)               | Денормализованное поле для хранения категорий продукта               | 8                           |
|                      | OrderId            | integer, fk         | Связь с таблицей Order через OrderId.                         | 4                           |
| **Итого**            |                    |                     |                                                               | **2193 байт**               |
| **ProfileProduct**         | ProfileId         | integer, pk fk        | Связь с таблицей Profile через ProfileId.            | 4                           |
|                      | ProductId         | integer, pk fk        | Связь с таблицей Product через ProducteId.            | 4                           |
| **Итого**            |                    |                     |                                                               | **8 байт**                 |
| **Category**         | CategoryId         | integer, pk         | Уникальный идентификатор категории (автоинкремент).            | 4                           |
|                      | Name               | varchar(20)         | Название категории.                                           | 20                          |
|                      | ParentId           | integer, fk         | Связь с таблицей Category через CategoryId (для подкатегорий). | 4                           |
| **Итого**            |                    |                     |                                                               | **28 байт**                 |
| **ProductCategory**  | ProductId          | integer, fk, pk     | Связь с таблицей Product через SKU.                           | 4                           |
|                      | CategoryId         | integer, fk, pk     | Связь с таблицей Category через CategoryId.                   | 4                           |
| **Итого**            |                    |                     |                                                               | **8 байт**                  |
| **OrderProduct**     | OrderId            | integer, fk, pk     | Связь с таблицей Order через OrderId.                         | 4                           |
|                      | ProductId          | integer, fk, pk     | Связь с таблицей Product через SKU.                           | 4                           |
| **Итого**            |                    |                     |                                                               | **8 байт**                  |
| **MediaFile**        | MediaFileId        | integer, pk         | Уникальный идентификатор медиафайла (автоинкремент).           | 4                           |
|                      | Type               | varchar(10)         | Тип медиафайла (например, изображение, видео).                | 10                          |
|                      | RelativeUrl        | varchar(40)         | URL для доступа к файлу.                                      | 40                          |
|                      | ProductId          | integer, fk, pk     | Связь с таблицей Product через SKU.                           | 4                           |
|                      | Position           | integer             | Порядок отображения медиафайлов.                              | 4                           |
| **Итого**            |                    |                     |                                                               | **62 байта**                |
| **PostOffice**       | PostOfficeId       | integer, pk         | Уникальный идентификатор почтового отделения (автоинкремент).  | 4                           |
|                      | location           | varchar(200)        | Адрес почтового отделения.                                    | 200                         |
|                      | WorkTime           | varchar(200)        | Время работы почтового отделения.                             | 200                         |
| **Итого**            |                    |                     |                                                               | **404 байта**               |
| **FeedBack**         | FeedBackId         | integer, pk         | Уникальный идентификатор отзыва (автоинкремент).               | 4                           |
|                      | ProductId          | integer, fk         | Связь с таблицей Product через SKU.                           | 4                           |
|                      | ProfileId          | integer, fk         | Связь с таблицей Profile через ProfileId.                     | 4                           |
|                      | CreatedAt          | timestamp           | Время создания отзыва.                                        | 8                           |
|                      | Payload            | varchar(200)        | Текст отзыва.                                                 | 200                         |
|                      | Rate               | integer             | Оценка продукта (1-5).                                        | 4                           |
| **Итого**            |                    |                     |                                                               | **224 байта**               |
| **Session**	|SessionId |	integer, pk | 	Уникальный идентификатор сессии (автоинкремент). |	4 |
| | ProfileId |	integer, fk |	Связь с таблицей Profile через ProfileId.	| 4 |
| | CreatedAt |	timestamp |	Время создания сессии. |	8 |
| | ExpiresAt | 	timestamp	 | Время истечения сессии. | 	8  |
| | Token | 	varchar(255) | 	Уникальный токен для идентификации сессии. |	255 |
| |  IsActive | 	boolean	| Указывает, активна ли сессия. | 	1  |
| **Итого** |                    |                     |                                                               |			**280 байт** |




### Оптимизация базы данных: Индексы, денормализация и масштабирование

1. Индексы
- **Profile.Mail** — необходимо создать уникальный индекс, так как поле может использоваться для аутентификации и поиска профилей.
- **Order.CreatedAt**, **Order.Status** — индексация для ускорения запросов на фильтрацию заказов по дате создания или статусу.
- **Product.Name** — индекс для ускорения поиска по названию товаров.
- **Category.Name** — так как часто используется поиск или фильтрация по категориям.
- **FeedBack.ProductId** и **FeedBack.ProfileId** — индексация для связи с продуктами и пользователями.
- **Session.Token** — уникальный индекс для быстрого поиска активных сессий по токенам.

2. Выбор СУБД (потаблично)
  
| Таблица           | Описание                                                                                          | Выбор СУБД                                |
|-------------------|---------------------------------------------------------------------------------------------------|-------------------------------------------|
| **Profile**        | Содержит информацию о профилях пользователей, включая email, имя и пароль.                        | PostgreSQL      |
| **Address**        | Хранит данные о адресах доставки, привязанных к профилям пользователей.                           | PostgreSQL      |
| **Order**          | Содержит информацию о заказах, включая дату создания, статус, адрес доставки и постамат.          | PostgreSQL     |
| **Product**        | Информация о продуктах: название, цена, описание.                                                 | PostgreSQL     |
| **ProductElasticSearch**        | Информация, необходимую для полнотекстового поиска по товарам                                                 | Elasticsearch     |
| **Category**       | Иерархическая структура категорий товаров, может иметь вложенные подкатегории.                    | PostgreSQL    |
| **ProductCategory**| Связь между товарами и категориями для быстрой фильтрации.                                        | PostgreSQL      |
| **ProductProfile**| Связь между товарами и пользователями для функции сравнения товаров.                                        | PostgreSQL      |
| **OrderProduct**   | Связь между заказами и товарами для хранения списка товаров в заказе.                             | PostgreSQL      |
| **MediaFile**      | Хранит метаданные медиафайлов (тип файла и URL) для продуктов и отзывов.                          | MongoDB                |
| **ProductMedia**   | Связь между товарами и медиафайлами для хранения изображений или видео.                           | MongoDB                   |
| **PostOffice**     | Содержит информацию о постаматах, включая местоположение и рабочее время.                         | PostgreSQL    |
| **FeedBack**       | Хранит отзывы пользователей о товарах с текстом и рейтингом.                                      | MongoDB                   |
| **FeedBackElascticSearch**       | Информация, для быстрого поиска оценки для товара                                  | Elasticsearch                   |
| **Session** | Информация о сессиях пользователей: токен, время создания, истечения и активность.                    | Redis            |

3. Шардирование и резервирование СУБД (потаблично)
- **Profile, Order** — горизонтальное шардирование по идентификатору пользователя или регионам, чтобы равномерно распределить нагрузку.
- **Product, Category** — для масштабирования возможна репликация.
- **FeedBack, MediaFile** — шардирование по идентификатору продукта для распределения данных отзывов и медиафайлов.
- **Session** — можно использовать шардирование по SessionId или по времени создания для равномерного распределения активных сессий между серверами.
- **Резервирование** — мастер-слейв репликацию для обеспечения отказоустойчивости и быстрой доступности данных.

4. Клиентские библиотеки / интеграции
- **PostgreSQL** — psycopg2 (Python), Sequelize (Node.js), SQLAlchemy (Python).
- **NoSQL** — pymongo (MongoDB, Python), Mongoose (MongoDB, Node.js).
- **Redis** — для кэширования частых запросов и храения сессий
- **Elasticsearch** — для сложного поиска товаров и фильтров.

5. Балансировка запросов / мультиплексирование подключений
- **PgBouncer** для PostgreSQL: это решение для подключения к нескольким инстансам базы данных и балансировки запросов между ними.
- **NGINX** можно использовать для балансировки запросов на уровне веб-серверов, распределяя запросы к разным инстансам базы данных.

6. Схема резервного копирования
- **PostgreSQL**: использовать **pg_dump** для периодического создания бэкапов с последующим хранением на внешних серверах.
- **NoSQL** (MongoDB): использовать **mongodump** для регулярного копирования данных.
- **Ротация бэкапов**: хранить ежедневные бэкапы за последнюю неделю, еженедельные за последний месяц и ежемесячные за последний год.
- Внедрение стратегии горячих и холодных резервных копий для минимизации времени простоя при восстановлении.

<h2 id="7">7 Алгоритмы</h2>

### Система сбора и хранения метрик для рекомендаций
Основные задачи системы включают сбор метрик, мониторинг производительности и хранение данных взаимодействия пользователей для улучшения качества рекомендаций. 

Метрики помогают оптимизировать алгоритмы рекомендаций, отслеживать изменения в реальном времени и выявлять потенциальные узкие места в системе. В этом документе представлены подходы к мониторингу, кэшированию, хранению и обработке данных для построения эффективной системы рекомендаций.

#### 1. Технологии для сбора метрик

Для мониторинга и сбора метрик системы рекомендуется использовать **Prometheus** и **Grafana**:

- **Prometheus**: Основной инструмент для сбора метрик в реальном времени, интегрируемый с микросервисами с помощью `Prometheus Exporter`.
  - **Поддержка метрик**: Метрики производительности (RPS, задержка отклика модели), точности (CTR — соотношение кликов к просмотрам) и надежности (ошибки в предсказаниях).
  - **Особенности хранения**: Prometheus сохраняет данные как временные ряды, что позволяет анализировать их с течением времени.

- **Grafana**: Визуализация метрик Prometheus с помощью дашбордов.
  - **Пример дашбордов**: Метрики успешных рекомендаций, процент ошибок предсказания, загрузка базы данных, среднее время отклика, количество запросов в минуту.
  - **Алерты**: Позволяет настраивать оповещения об отклонениях от SLA (например, превышение порога задержки) или других аномалиях.

#### 2. Хранение данных для рекомендаций

Для хранения данных о взаимодействиях пользователей с продуктами, результатах рекомендаций и исторических данных используются дополнительные таблицы базы данных, такие как `UserActivityMetrics` и `RecommendationMetrics`. Эти таблицы хранят данные об активности пользователя (просмотры, клики, покупки), а также метрики, связанные с рекомендациями (время отклика модели, список рекомендованных продуктов).

| Таблица                  | Поле                  | Тип данных    | Описание                                                            |
|-------------------------|----------------------|---------------|---------------------------------------------------------------------|
| **UserActivityMetrics**  | ActivityId           | SERIAL        | Уникальный идентификатор активности                                  |
|                         | UserId               | INTEGER       | Идентификатор пользователя (внешний ключ из таблицы Profile)       |
|                         | ProductId            | INTEGER       | Идентификатор продукта (внешний ключ из таблицы Product)           |
|                         | ActivityType         | VARCHAR(20)   | Тип активности: "view", "click", "purchase"                        |
|                         | Timestamp            | TIMESTAMP     | Дата и время активности                                             |
| **RecommendationMetrics** | RecId                | SERIAL        | Уникальный идентификатор рекомендации                                |
|                         | UserId               | INTEGER       | Идентификатор пользователя (внешний ключ из таблицы Profile)       |
|                         | RecommendedProducts   | JSONB         | JSON со списком рекомендованных продуктов                           |
|                         | ResponseTime         | FLOAT         | Время отклика модели (в миллисекундах)                             |
|                         | Timestamp            | TIMESTAMP     | Дата и время создания записи                                        |

#### 3. Подходы к кэшированию

Для повышения скорости работы системы и снижения нагрузки на базу данных используется кэширование:

- **Redis**: Хранение часто запрашиваемых данных, таких как популярные рекомендации или профили поведения пользователей.
- **Кэширование рекомендаций**: В Redis можно хранить рекомендации для каждого пользователя, обновляя данные по мере необходимости.

#### 4. Модели и алгоритмы для рекомендаций

Рекомендуемая модель рекомендаций в высоконагруженной системе использует:

- **Collaborative Filtering** и **Content-Based Filtering** для поиска похожих пользователей или продуктов.
- **Factorization Machines (FM)** или **Neural Collaborative Filtering (NCF)** для создания рекомендаций на основе комплексных паттернов.
- **Exploration-Exploitation** (например, ε-greedy или UCB) для учета новых данных в рекомендациях.

#### 5. Пример мониторинга и алертов с Prometheus и Grafana

Prometheus позволяет собирать метрики с базы данных и API. Примеры метрик для мониторинга:

- **Запросы на рекомендации в минуту (RPS)** для анализа нагрузки.
- **Средняя задержка отклика модели** для мониторинга производительности.
- **Процент успешных рекомендаций** для измерения эффективности.

Для настройки алертов в Grafana можно создать следующие условия:

- Уведомления, если **средняя задержка отклика** превышает 1000 мс.
- Оповещения, если **процент ошибок предсказаний** превышает 5%.

#### 6. Стратегия хранения и резервного копирования данных

Периодическое резервное копирование метрик и данных помогает избежать потерь при сбоях:

- **Резервные копии базы данных**: PostgreSQL можно использовать с инструментом `pg_dump` для создания резервных копий. Данные из таблиц с метриками можно хранить на отдельном сервере.
- **MongoDB** для резервного хранения массивов данных (например, истории рекомендаций или логов метрик).
- **Ротация бэкапов**: Хранить ежедневные бэкапы за последнюю неделю, еженедельные за последний месяц и ежемесячные за последний год.

